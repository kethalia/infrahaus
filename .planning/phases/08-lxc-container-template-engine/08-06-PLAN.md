---
phase: 08-lxc-container-template-engine
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/forge-shield/scripts/40_security-web.sh
  - templates/forge-shield/scripts/41_security-solidity.sh
  - templates/forge-shield/scripts/42_zap.sh
  - templates/forge-shield/scripts/50_claude-skills.sh
  - templates/forge-shield/scripts/60_shell-setup.sh
  - templates/forge-shield/scripts/99_verify.sh
autonomous: true

must_haves:
  truths:
    - "Semgrep, Trivy, Gitleaks, nmap, and nikto are installed"
    - "Slither, Aderyn, Echidna, and Solhint are installed (Mythril attempted with fallback)"
    - "ZAP is installed in headless mode"
    - "Claude skills (security commands) are set up for the user"
    - "Zsh with a usable shell setup is configured"
    - "99_verify.sh validates all critical tools are available"
  artifacts:
    - path: "templates/forge-shield/scripts/40_security-web.sh"
      provides: "Web security tools (Semgrep, Trivy, Gitleaks)"
      min_lines: 25
    - path: "templates/forge-shield/scripts/41_security-solidity.sh"
      provides: "Solidity security tools (Slither, Aderyn, Echidna, Mythril)"
      min_lines: 30
    - path: "templates/forge-shield/scripts/42_zap.sh"
      provides: "OWASP ZAP installation"
      min_lines: 15
    - path: "templates/forge-shield/scripts/50_claude-skills.sh"
      provides: "Claude security skill commands setup"
      min_lines: 10
    - path: "templates/forge-shield/scripts/60_shell-setup.sh"
      provides: "Zsh configuration with useful defaults"
      min_lines: 20
    - path: "templates/forge-shield/scripts/99_verify.sh"
      provides: "Final verification of all installed tools"
      min_lines: 30
  key_links: []
---

<objective>
Create the security tool scripts, Claude skills setup, shell configuration, and final verification script for the forge-shield template.

Purpose: These scripts complete the forge-shield template by installing all security analysis tools (web + Solidity), setting up Claude slash commands for security workflows, configuring a usable zsh shell, and providing a final verification script that confirms everything is working.
Output: 6 provisioning scripts in `templates/forge-shield/scripts/`
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lxc-container-template-engine/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security tool installation scripts</name>
  <files>
    templates/forge-shield/scripts/40_security-web.sh
    templates/forge-shield/scripts/41_security-solidity.sh
    templates/forge-shield/scripts/42_zap.sh
  </files>
  <action>
Create three security tool installation scripts. All must be executable, use `#!/usr/bin/env bash`, `set -euo pipefail`, be idempotent, run as root. `USERNAME` env var available.

**40_security-web.sh** — Web/general security tools:

- **Semgrep:** Guard `su - $USERNAME -c "command -v semgrep"` → skip. Install: `su - $USERNAME -c "pipx install semgrep"`. Verify: `su - $USERNAME -c "semgrep --version"`.
- **Trivy:** Guard `command -v trivy` → skip. Install from GitHub releases:
  ```
  TRIVY_VER=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep -oP '"tag_name":\s*"v\K[^"]+')
  wget -q "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VER}/trivy_${TRIVY_VER}_Linux-64bit.tar.gz" -O /tmp/trivy.tar.gz
  tar xzf /tmp/trivy.tar.gz -C /usr/local/bin trivy
  chmod +x /usr/local/bin/trivy
  rm /tmp/trivy.tar.gz
  ```
  Verify: `trivy --version`
- **Gitleaks:** Guard `command -v gitleaks` → skip. Install from GitHub releases:
  ```
  GITLEAKS_VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep -oP '"tag_name":\s*"v\K[^"]+')
  wget -q "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VER}/gitleaks_${GITLEAKS_VER}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz
  tar xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks
  chmod +x /usr/local/bin/gitleaks
  rm /tmp/gitleaks.tar.gz
  ```
  Verify: `gitleaks version`
- nmap and nikto are installed via apt packages (in template.yaml), no script action needed. Just verify they exist.
- Log with `[40_security-web]` prefix

**41_security-solidity.sh** — Solidity-specific security tools:

- **Slither:** Guard `su - $USERNAME -c "command -v slither"` → skip. Install: `su - $USERNAME -c "pipx install slither-analyzer"`. Verify: `su - $USERNAME -c "slither --version"`.
- **Aderyn:** Guard `su - $USERNAME -c "command -v aderyn"` → skip. Install via installer: `su - $USERNAME -c "curl --proto '=https' --tlsv1.2 -LsSf https://github.com/cyfrin/aderyn/releases/latest/download/aderyn-installer.sh | bash"`. Verify: `su - $USERNAME -c "aderyn --version"`.
- **Echidna:** Guard `command -v echidna` → skip. Install pre-built binary:
  ```
  ECHIDNA_VER=$(curl -s https://api.github.com/repos/crytic/echidna/releases/latest | grep -oP '"tag_name":\s*"\K[^"]+')
  wget -q "https://github.com/crytic/echidna/releases/download/${ECHIDNA_VER}/echidna-${ECHIDNA_VER}-Linux.zip" -O /tmp/echidna.zip
  unzip -o /tmp/echidna.zip -d /tmp/echidna-extract
  find /tmp/echidna-extract -name echidna -type f -exec cp {} /usr/local/bin/echidna \;
  chmod +x /usr/local/bin/echidna
  rm -rf /tmp/echidna.zip /tmp/echidna-extract
  ```
  Verify: `echidna --version || echidna --help`
- **Mythril:** Guard `su - $USERNAME -c "command -v myth"` → skip. This is RISKY — z3 compilation can take 30+ min and may fail on Python 3.12. Install with fallback:
  ```
  # Try pipx install with timeout
  apt-get install -y libz3-dev python3-z3 || true
  if timeout 600 su - $USERNAME -c "pipx install mythril" 2>/dev/null; then
      echo "[41_security-solidity] Mythril installed successfully"
  else
      echo "[41_security-solidity] WARNING: Mythril installation failed or timed out. Skipping."
      echo "[41_security-solidity] Mythril can be installed manually later: pipx install mythril"
  fi
  ```
  Do NOT let Mythril failure abort the entire script — use || true pattern.
- **Solhint:** Guard `su - $USERNAME -c "command -v solhint"` → skip. Install: `su - $USERNAME -c "npm install -g solhint"`. Verify: `su - $USERNAME -c "solhint --version"`.
- Log with `[41_security-solidity]` prefix

**42_zap.sh** — OWASP ZAP (headless):

- Guard: `[[ -d /opt/zaproxy ]]` → skip
- Install Java (default-jre should already be in apt packages, but verify): `apt-get install -y default-jre`
- Download ZAP weekly release:
  ```
  wget -q "https://github.com/zaproxy/zaproxy/releases/download/w2025-01-01/ZAP_WEEKLY_unix.tar.gz" -O /tmp/zap.tar.gz
  ```
  OR use the latest release approach (more robust):
  ```
  # Get latest weekly release tag
  ZAP_URL=$(curl -s https://api.github.com/repos/zaproxy/zaproxy/releases | grep -m1 'browser_download_url.*ZAP_WEEKLY_unix.tar.gz' | grep -oP '"https://[^"]+')
  wget -q "$ZAP_URL" -O /tmp/zap.tar.gz
  ```
- Extract: `mkdir -p /opt/zaproxy && tar xzf /tmp/zap.tar.gz -C /opt/zaproxy --strip-components=1`
- Symlink: `ln -sf /opt/zaproxy/zap.sh /usr/local/bin/zap`
- Clean up: `rm /tmp/zap.tar.gz`
- Verify: `zap -cmd -version 2>/dev/null || echo "ZAP installed (version check may require display)"`
- Note: ZAP is large (~500MB). Log this to set expectations.
- Log with `[42_zap]` prefix
  </action>
  <verify>
  `bash -n templates/forge-shield/scripts/40_security-web.sh && bash -n templates/forge-shield/scripts/41_security-solidity.sh && bash -n templates/forge-shield/scripts/42_zap.sh` — all pass syntax check.
  </verify>
  <done>Web security tools (Semgrep, Trivy, Gitleaks) installed. Solidity tools (Slither, Aderyn, Echidna, Mythril with fallback, Solhint) installed. ZAP installed in headless mode.</done>
  </task>

<task type="auto">
  <name>Task 2: Create Claude skills, shell setup, and verification scripts</name>
  <files>
    templates/forge-shield/scripts/50_claude-skills.sh
    templates/forge-shield/scripts/60_shell-setup.sh
    templates/forge-shield/scripts/99_verify.sh
  </files>
  <action>
Create three more provisioning scripts. Same conventions.

**50_claude-skills.sh** — Set up Claude security skills/commands:

- Guard: check if `/home/$USERNAME/.claude/commands/` has files → skip
- This script creates the Claude slash command files and CLAUDE.md. However, the actual file CONTENTS are in the files/ directory and get pushed by the engine. So this script should:
  - Ensure the directories exist: `su - $USERNAME -c "mkdir -p ~/.claude/commands ~/.claude/skills"`
  - Set correct ownership
  - Log that files will be pushed by the engine's file push phase
- If you want to also install community security skills from GitHub:
  - `su - $USERNAME -c "git clone --depth 1 https://github.com/anthropics/claude-code-skills.git /tmp/claude-skills 2>/dev/null || true"`
  - Copy security-related skills if the repo exists: `su - $USERNAME -c "cp -r /tmp/claude-skills/security/* ~/.claude/skills/ 2>/dev/null || true"`
  - Clean up: `su - $USERNAME -c "rm -rf /tmp/claude-skills"`
- Log with `[50_claude-skills]` prefix

**60_shell-setup.sh** — Configure zsh with usable defaults:

- Guard: check if `/home/$USERNAME/.zshrc` exists and has been configured (grep for a marker comment) → skip
- Install oh-my-zsh for the user (popular, provides good defaults):
  ```
  su - $USERNAME -c 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended'
  ```
- Configure .zshrc with useful settings (append or create):
  - Set ZSH_THEME to a simple theme like "robbyrussell" (already default in oh-my-zsh)
  - Enable useful plugins: `plugins=(git docker node npm python rust golang fzf)`
  - Add PATH exports for all tool directories (foundry, cargo, go, npm-global, local/bin)
  - Add useful aliases:
    - `alias ll='ls -alF'`
    - `alias la='ls -A'`
    - `alias security-gate='~/.local/bin/security-gate.sh'`
    - `alias zap-scan='~/.local/bin/zap-scan.sh'`
  - Add a marker comment: `# forge-shield shell config`
  - Source cargo env if it exists: `[[ -f ~/.cargo/env ]] && source ~/.cargo/env`
- Change user's default shell to zsh: `chsh -s /bin/zsh $USERNAME`
- Ensure .zshrc is owned by user: `chown $USERNAME:$USERNAME /home/$USERNAME/.zshrc`
- Log with `[60_shell-setup]` prefix

**99_verify.sh** — Final verification of all installed tools:

- This is the last script to run. It checks every tool and produces a summary.
- Structure: list of tool checks with pass/fail reporting
- Check each tool (using `su - $USERNAME -c` for user-installed tools):
  - **Languages:** node, npm, python3, go, rustc, cargo
  - **EVM:** forge, cast, anvil, solc-select, solhint
  - **Security (web):** semgrep, trivy, gitleaks, nmap, nikto
  - **Security (Solidity):** slither, aderyn, echidna, myth (optional)
  - **AI:** claude, opencode (optional)
  - **Shell:** zsh
  - **ZAP:** check /opt/zaproxy/zap.sh exists
- For each tool: `command -v TOOL &>/dev/null && echo "  ✓ TOOL" || echo "  ✗ TOOL (NOT FOUND)"`
- Count passes/failures. Print summary: "X/Y tools verified"
- Exit 0 even if some optional tools failed (myth, opencode are optional)
- Exit 1 only if critical tools (node, python3, forge, slither) are missing
- Log with `[99_verify]` prefix
  </action>
  <verify>
  `bash -n templates/forge-shield/scripts/50_claude-skills.sh && bash -n templates/forge-shield/scripts/60_shell-setup.sh && bash -n templates/forge-shield/scripts/99_verify.sh` — all pass syntax check.
  </verify>
  <done>50_claude-skills.sh sets up Claude command directories. 60_shell-setup.sh configures zsh with oh-my-zsh and useful defaults. 99_verify.sh validates all tools and prints summary.</done>
  </task>

</tasks>

<verification>
All 6 scripts pass `bash -n` syntax check. Scripts cover all security tools from the user's spec. 99_verify.sh checks every tool. Shell is configured with zsh + oh-my-zsh.
</verification>

<success_criteria>

- Security web tools: Semgrep (pipx), Trivy (binary), Gitleaks (binary) installed
- Security Solidity tools: Slither (pipx), Aderyn (installer), Echidna (binary), Mythril (with fallback), Solhint (npm)
- ZAP installed in /opt/zaproxy with symlink
- Claude skills directories created, community skills cloned if available
- Zsh configured with oh-my-zsh, useful plugins, tool PATH entries, aliases
- 99_verify.sh validates all tools with clear pass/fail output
  </success_criteria>

<output>
After completion, create `.planning/phases/08-lxc-container-template-engine/08-06-SUMMARY.md`
</output>
