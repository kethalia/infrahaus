---
phase: 07-vm-to-run-openclaw
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/vm/templates/openclaw-desktop/template.conf
  - infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml
  - infra/vm/templates/openclaw-desktop/create-vm.sh
autonomous: true

must_haves:
  truths:
    - "template.conf defines VM metadata matching LXC template pattern (app name, tags, resources)"
    - "cloud-init user-data configures the openclaw user with auto-login, desktop packages, and service enablement"
    - "create-vm.sh is a wrapper that sources the community Debian 13 VM script with pre-configured defaults for desktop use"
  artifacts:
    - path: "infra/vm/templates/openclaw-desktop/template.conf"
      provides: "VM template metadata and resource defaults"
      contains: "TEMPLATE_APP"
    - path: "infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml"
      provides: "Cloud-init configuration for desktop environment"
      contains: "task-xfce-desktop"
    - path: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      provides: "VM creation wrapper script"
      contains: "debian-13-vm.sh"
  key_links:
    - from: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      to: "infra/vm/templates/openclaw-desktop/template.conf"
      via: "source template.conf"
      pattern: "source.*template\\.conf"
    - from: "infra/vm/templates/openclaw-desktop/create-vm.sh"
      to: "community-scripts/ProxmoxVE debian-13-vm.sh"
      via: "curl + source or reference"
      pattern: "debian-13-vm"
---

<objective>
Create the VM template directory structure with configuration metadata, cloud-init user-data, and the VM creation wrapper script that uses the ProxmoxVE community Debian 13 VM script as its foundation.

Purpose: Establish the VM template scaffolding following the same pattern as the existing LXC template (infra/lxc/templates/web3-dev/), adapted for VM-specific concerns (cloud-init, UEFI boot, virtio drivers, desktop resources).

Output: Three files — template.conf (metadata), cloud-init/user-data.yaml (desktop provisioning), and create-vm.sh (entry point that wraps the community script).
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-vm-to-run-openclaw/07-RESEARCH.md

# Existing LXC template for pattern reference

@infra/lxc/templates/web3-dev/template.conf
@infra/lxc/templates/web3-dev/container.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template.conf and cloud-init user-data.yaml</name>
  <files>
    infra/vm/templates/openclaw-desktop/template.conf
    infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/template.conf` following the exact pattern of `infra/lxc/templates/web3-dev/template.conf` but adapted for VM:

```bash
#!/usr/bin/env bash
# OpenClaw Desktop VM Template Configuration

# Template identification
TEMPLATE_APP="OpenClaw Desktop"
TEMPLATE_TAGS="openclaw;desktop;xfce;nodejs;chrome"
TEMPLATE_DESCRIPTION="Desktop VM with XFCE, Chrome, Node.js for running OpenClaw GUI applications"

# VM configuration path (relative to repository root)
TEMPLATE_CONFIG_PATH="infra/vm/templates/openclaw-desktop"

# Resource defaults (desktop-appropriate — higher than server defaults)
TEMPLATE_CPU="${TEMPLATE_CPU:-4}"
TEMPLATE_RAM="${TEMPLATE_RAM:-4096}"
TEMPLATE_DISK="${TEMPLATE_DISK:-32G}"
TEMPLATE_OS="${TEMPLATE_OS:-debian}"
TEMPLATE_VERSION="${TEMPLATE_VERSION:-13}"

# VM-specific settings
TEMPLATE_MACHINE="${TEMPLATE_MACHINE:-q35}"
TEMPLATE_BIOS="${TEMPLATE_BIOS:-ovmf}"
TEMPLATE_DISPLAY="${TEMPLATE_DISPLAY:-virtio}"
TEMPLATE_CPU_TYPE="${TEMPLATE_CPU_TYPE:-host}"
TEMPLATE_CLOUD_INIT="${TEMPLATE_CLOUD_INIT:-yes}"
TEMPLATE_START_VM="${TEMPLATE_START_VM:-yes}"

# User configuration
TEMPLATE_USER="${TEMPLATE_USER:-openclaw}"
TEMPLATE_HOSTNAME="${TEMPLATE_HOSTNAME:-openclaw-desktop}"
```

Create `infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml` as a cloud-init config:

```yaml
#cloud-config
hostname: openclaw-desktop
manage_etc_hosts: true

users:
  - name: openclaw
    groups: sudo,audio,video,render
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false

package_update: true
package_upgrade: true

packages:
  # Desktop environment (XFCE - lightweight)
  - task-xfce-desktop
  - lightdm
  - lightdm-gtk-greeter
  # Remote access
  - tigervnc-standalone-server
  - tigervnc-tools
  # VM integration
  - qemu-guest-agent
  # System utilities
  - curl
  - wget
  - ca-certificates
  - gnupg
  - software-properties-common
  - git
  - unzip

write_files:
  # LightDM auto-login configuration
  - path: /etc/lightdm/lightdm.conf.d/50-autologin.conf
    content: |
      [Seat:*]
      autologin-user=openclaw
      autologin-user-timeout=0
      greeter-session=lightdm-gtk-greeter
    permissions: "0644"

  # VNC server systemd service template
  - path: /etc/systemd/system/vncserver@.service
    content: |
      [Unit]
      Description=TigerVNC server on display :%i
      After=syslog.target network.target

      [Service]
      Type=forking
      User=openclaw
      Group=openclaw
      WorkingDirectory=/home/openclaw
      ExecStartPre=-/usr/bin/vncserver -kill :%i > /dev/null 2>&1
      ExecStart=/usr/bin/vncserver -depth 24 -geometry 1920x1080 -localhost no :%i
      ExecStop=/usr/bin/vncserver -kill :%i

      [Install]
      WantedBy=multi-user.target
    permissions: "0644"

runcmd:
  # Install Node.js 22 via NodeSource
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install Google Chrome
  - curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
  - apt-get update && apt-get install -y google-chrome-stable

  # Configure VNC for openclaw user
  - sudo -u openclaw mkdir -p /home/openclaw/.vnc
  - echo "openclaw" | sudo -u openclaw vncpasswd -f > /home/openclaw/.vnc/passwd
  - chmod 600 /home/openclaw/.vnc/passwd
  - chown openclaw:openclaw /home/openclaw/.vnc/passwd

  # Create VNC xstartup
  - |
    cat > /home/openclaw/.vnc/xstartup << 'XSTARTUP'
    #!/bin/sh
    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS
    exec startxfce4
    XSTARTUP
  - chmod +x /home/openclaw/.vnc/xstartup
  - chown openclaw:openclaw /home/openclaw/.vnc/xstartup

  # Enable services
  - systemctl enable lightdm
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - systemctl enable vncserver@1

  # Install OpenClaw globally
  - npm install -g openclaw@latest

  # Set openclaw user password (same as username for simplicity — user can change)
  - echo "openclaw:openclaw" | chpasswd

  # Final reboot to start desktop environment
  - reboot

final_message: "OpenClaw Desktop VM setup complete after $UPTIME seconds"
```

Use modern GPG keyring approach for Chrome (not deprecated apt-key). Use `-localhost no` on VNC so remote connections work.
</action>
<verify> - `cat infra/vm/templates/openclaw-desktop/template.conf` shows all TEMPLATE\_\* variables - `cat infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml` starts with `#cloud-config` - Verify cloud-init YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('infra/vm/templates/openclaw-desktop/cloud-init/user-data.yaml'))"` - Verify template.conf is valid bash: `bash -n infra/vm/templates/openclaw-desktop/template.conf`
</verify>
<done> - template.conf defines TEMPLATE_APP="OpenClaw Desktop" with desktop-appropriate resources (4 CPU, 4096 RAM, 32G disk) - cloud-init user-data.yaml installs: XFCE desktop, LightDM, TigerVNC, Chrome, Node.js 22, QEMU guest agent, OpenClaw - cloud-init configures: auto-login via LightDM, VNC server on display :1, openclaw user with sudo
</done>
</task>

<task type="auto">
  <name>Task 2: Create VM creation wrapper script (create-vm.sh)</name>
  <files>
    infra/vm/templates/openclaw-desktop/create-vm.sh
  </files>
  <action>
Create `infra/vm/templates/openclaw-desktop/create-vm.sh` — the main entry point for creating an OpenClaw Desktop VM.

This script should:

1. Source `template.conf` for defaults
2. Display a header/banner for the OpenClaw Desktop template
3. Override the community script defaults with our desktop-appropriate values
4. Call the community Debian 13 VM script with `CLOUD_INIT=yes` to create the base VM
5. After the community script completes, copy the cloud-init user-data.yaml to the Proxmox snippets directory
6. Apply the cloud-init config to the VM
7. If the VM was started by the community script, restart it so cloud-init runs with our config

Key implementation details:

- The community script is interactive (whiptail) — we want to let the user go through it but with our defaults pre-set
- We need to detect the VMID after the community script runs (it sets $VMID)
- After the community script finishes, we apply our cloud-init config
- The script should work when run from the Proxmox host shell

Structure:

```bash
#!/usr/bin/env bash
# OpenClaw Desktop VM Creator
# Creates a Debian 13 VM with desktop environment for OpenClaw
#
# Usage: bash create-vm.sh
# Must be run on the Proxmox host as root.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source template configuration
source "${SCRIPT_DIR}/template.conf"

echo "============================================"
echo "  OpenClaw Desktop VM Creator"
echo "============================================"
echo ""
echo "This will create a Debian 13 VM with:"
echo "  - XFCE desktop environment"
echo "  - Auto-login (user: openclaw)"
echo "  - Google Chrome browser"
echo "  - Node.js 22+ runtime"
echo "  - TigerVNC remote access (port 5901)"
echo "  - QEMU guest agent"
echo "  - OpenClaw (installed globally)"
echo ""
echo "Resource defaults: ${TEMPLATE_CPU} cores, ${TEMPLATE_RAM}MB RAM, ${TEMPLATE_DISK} disk"
echo ""

# Pre-set environment variables that the community script reads
# These override the community script defaults with desktop-appropriate values
export var_cpu="${TEMPLATE_CPU}"
export var_ram="${TEMPLATE_RAM}"
export DISK_SIZE="${TEMPLATE_DISK}"
export HN="${TEMPLATE_HOSTNAME}"
export CLOUD_INIT="yes"
export START_VM="${TEMPLATE_START_VM}"

# Run the community Debian 13 VM script
# This handles: VM creation, storage selection, networking, disk import
echo "Launching Proxmox community script for base Debian 13 VM..."
echo "(You can accept defaults or customize in the dialog)"
echo ""

# Source the community script — it will create the VM and set $VMID
bash -c "$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/vm/debian-13-vm.sh)"

# After community script completes, $VMID should be set
# But since we ran it in a subshell via bash -c, we need to detect the VM
# Find the most recently created Debian VM
VMID=$(qm list | grep "${TEMPLATE_HOSTNAME}" | awk '{print $1}' | tail -1)

if [[ -z "$VMID" ]]; then
  echo "ERROR: Could not find created VM. Looking for hostname '${TEMPLATE_HOSTNAME}'"
  echo "Available VMs:"
  qm list
  exit 1
fi

echo ""
echo "Found VM ${VMID} (${TEMPLATE_HOSTNAME})"

# Copy cloud-init user-data to Proxmox snippets directory
SNIPPETS_DIR="/var/lib/vz/snippets"
mkdir -p "${SNIPPETS_DIR}"

CLOUD_INIT_FILE="${SCRIPT_DIR}/cloud-init/user-data.yaml"
SNIPPET_NAME="openclaw-desktop-${VMID}.yaml"

if [[ ! -f "$CLOUD_INIT_FILE" ]]; then
  echo "ERROR: Cloud-init config not found at ${CLOUD_INIT_FILE}"
  exit 1
fi

cp "${CLOUD_INIT_FILE}" "${SNIPPETS_DIR}/${SNIPPET_NAME}"
echo "Cloud-init config copied to ${SNIPPETS_DIR}/${SNIPPET_NAME}"

# Apply cloud-init custom config to the VM
qm set "${VMID}" --cicustom "user=local:snippets/${SNIPPET_NAME}"

# Set display to virtio for better desktop performance
qm set "${VMID}" --vga "${TEMPLATE_DISPLAY}"

echo ""
echo "Cloud-init configuration applied to VM ${VMID}"

# If VM is already running, stop and restart to pick up cloud-init
if qm status "${VMID}" | grep -q "running"; then
  echo "Restarting VM to apply cloud-init configuration..."
  qm shutdown "${VMID}" --timeout 30 2>/dev/null || qm stop "${VMID}"
  sleep 3
  qm start "${VMID}"
  echo "VM restarted with cloud-init configuration"
elif [[ "${TEMPLATE_START_VM}" == "yes" ]]; then
  echo "Starting VM ${VMID}..."
  qm start "${VMID}"
fi

echo ""
echo "============================================"
echo "  OpenClaw Desktop VM Created!"
echo "============================================"
echo ""
echo "VM ID: ${VMID}"
echo "Hostname: ${TEMPLATE_HOSTNAME}"
echo ""
echo "Cloud-init is now installing the desktop environment."
echo "This process takes 10-20 minutes. The VM will reboot when complete."
echo ""
echo "Monitor progress:"
echo "  qm terminal ${VMID}    (serial console)"
echo "  qm guest exec ${VMID} -- cat /var/log/cloud-init-output.log"
echo ""
echo "After setup completes:"
echo "  - Proxmox Console: Use 'Console' button in Proxmox web UI"
echo "  - VNC: Connect to VM_IP:5901 (password: openclaw)"
echo "  - SSH: ssh openclaw@VM_IP"
echo ""
echo "Default credentials:"
echo "  User: openclaw"
echo "  Password: openclaw"
echo "  VNC Password: openclaw"
echo ""
echo "============================================"
```

Make the script executable: `chmod +x create-vm.sh`

IMPORTANT: The community script runs in a subshell via `bash -c`, so we can't capture its `$VMID` variable directly. Instead, we detect the created VM by searching `qm list` for our hostname. This is reliable because the community script sets the hostname.
</action>
<verify> - `bash -n infra/vm/templates/openclaw-desktop/create-vm.sh` — no syntax errors - `test -x infra/vm/templates/openclaw-desktop/create-vm.sh` — is executable - Script sources template.conf (grep for "source.\*template.conf") - Script references community Debian 13 VM script (grep for "debian-13-vm.sh") - Script handles cloud-init snippet deployment (grep for "cicustom")
</verify>
<done> - create-vm.sh is executable and sources template.conf for defaults - Script runs the community Debian 13 VM script via curl - After VM creation, script copies cloud-init user-data.yaml to /var/lib/vz/snippets/ - Script applies cloud-init config via `qm set --cicustom` - Script sets virtio display for desktop performance - Script outputs clear instructions for monitoring cloud-init progress and accessing the VM
</done>
</task>

</tasks>

<verification>
- Directory structure exists: `ls -la infra/vm/templates/openclaw-desktop/`
- All scripts pass bash syntax check: `bash -n infra/vm/templates/openclaw-desktop/create-vm.sh && bash -n infra/vm/templates/openclaw-desktop/template.conf`
- Cloud-init YAML is valid
- template.conf defines all required TEMPLATE_* variables
- create-vm.sh is executable and references both template.conf and community script
</verification>

<success_criteria>

- `infra/vm/templates/openclaw-desktop/` directory exists with template.conf, create-vm.sh, cloud-init/user-data.yaml
- template.conf mirrors LXC template pattern with VM-specific additions (machine type, BIOS, display, cloud-init)
- cloud-init installs all locked requirements: XFCE, LightDM, TigerVNC, Chrome, Node.js 22, QEMU guest agent, OpenClaw
- cloud-init configures auto-login and VNC server
- create-vm.sh wraps the community Debian 13 VM script and applies cloud-init post-creation
  </success_criteria>

<output>
After completion, create `.planning/phases/07-vm-to-run-openclaw/07-01-SUMMARY.md`
</output>
