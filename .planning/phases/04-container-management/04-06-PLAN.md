---
phase: 04-container-management
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/src/lib/proxmox/schemas.ts
  - apps/dashboard/src/lib/containers/data.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Container status schema accepts both boolean and integer (0/1) for ha.managed field"
    - "Proxmox API errors are logged to console with full error details"
    - "Lifecycle actions no longer fail due to schema validation errors"
  artifacts:
    - path: "apps/dashboard/src/lib/proxmox/schemas.ts"
      provides: "ContainerStatusSchema with pveBoolean for ha.managed"
      contains: "pveBoolean.transform"
    - path: "apps/dashboard/src/lib/containers/data.ts"
      provides: "Error logging in catch blocks"
      contains: "console.error"
  key_links:
    - from: "getContainersWithStatus()"
      to: "ContainerStatusSchema"
      via: "getContainer() validates Proxmox response"
    - from: "catch blocks"
      to: "console.error"
      via: "error logging for diagnostics"
---

<objective>
Fix Zod schema validation error for ha.managed field and add error logging for Proxmox connectivity diagnosis

Purpose: Address UAT gaps #2 and #3 - ha.managed field fails validation because Proxmox returns 0/1 integers but schema expects boolean; empty catch blocks hide actual Proxmox connectivity errors making diagnosis impossible
Output: Robust schema handling for Proxmox boolean fields, comprehensive error logging for debugging
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-container-management/04-UAT.md
@apps/dashboard/src/lib/proxmox/schemas.ts
@apps/dashboard/src/lib/containers/data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ha.managed schema to use pveBoolean helper</name>
  <files>apps/dashboard/src/lib/proxmox/schemas.ts</files>
  <action>
Fix the ContainerStatusSchema.ha.managed field to use the pveBoolean helper instead of z.boolean().

Current code (lines 142-148):

```typescript
ha: z
  .object({
    managed: z.boolean(),
  })
  .optional(),
```

The file already has a pveBoolean helper defined at line 191:

```typescript
const pveBoolean = z.union([z.boolean(), z.number()]).transform((v) => !!v);
```

Move this pveBoolean definition to BEFORE ContainerStatusSchema (before line 125) so it can be used there, then update ha.managed to use it:

```typescript
ha: z
  .object({
    managed: pveBoolean,
  })
  .optional(),
```

The pveBoolean pattern handles Proxmox's inconsistent return types (sometimes boolean, sometimes 0/1 integer) by accepting either and transforming to boolean.
</action>
<verify>grep -B5 "managed:" apps/dashboard/src/lib/proxmox/schemas.ts | grep -q "pveBoolean" && echo "PASS" || echo "FAIL"</verify>
<done>ha.managed uses pveBoolean helper, schema accepts both boolean and integer values</done>
</task>

<task type="auto">
  <name>Task 2: Add error logging to data.ts catch blocks</name>
  <files>apps/dashboard/src/lib/containers/data.ts</files>
  <action>
Add console.error logging to all empty catch blocks in data.ts to capture actual error messages for diagnosis.

Current empty catches to fix:

1. Line 172-174 (inside listContainers parallel fetch):

```typescript
} catch {
  // Node-level failure — continue with other nodes
  return [];
}
```

Add: `console.error(
`Node ${node.node} container list failed:`, error);`

2. Line 195-198 (Proxmox API unreachable):

```typescript
} catch {
  // Proxmox API completely unreachable
  proxmoxReachable = false;
}
```

Add: `console.error("Proxmox API unreachable:", error);`

3. Line 243-245 (getContainerDetailData fetch):

```typescript
} catch {
  proxmoxReachable = false;
}
```

Add: `console.error(
`Container ${dbContainer.vmid} detail fetch failed:`, error);`

4. Line 263-265 (credential decryption):

```typescript
} catch {
  // Decryption or parse failure — skip credentials
  credentials = null;
}
```

Add: `console.error("Credential decryption failed for service:", s.id, error);`

For each catch block:

- Add `error` parameter to catch: `catch (error)`
- Add console.error with descriptive context and the error object
- Keep existing fallback behavior (return [], set proxmoxReachable=false, etc.)
  </action>
  <verify>grep -c "console.error" apps/dashboard/src/lib/containers/data.ts | grep -q "4" && echo "PASS" || echo "FAIL"</verify>
  <done>All catch blocks log errors with descriptive context for debugging</done>
  </task>

</tasks>

<verification>
- [ ] ha.managed uses pveBoolean instead of z.boolean()
- [ ] pveBoolean is defined before ContainerStatusSchema
- [ ] All catch blocks in data.ts have console.error statements
- [ ] Each error log includes descriptive context (function/container/node info)
- [ ] Existing fallback behavior preserved (returns, flag settings)
</verification>

<success_criteria>

- Schema validation accepts Proxmox 0/1 integers for ha.managed
- Lifecycle actions no longer fail with schema validation errors
- Proxmox connectivity errors are logged with full details
- Error messages include context for debugging
  </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-06-SUMMARY.md`
</output>
