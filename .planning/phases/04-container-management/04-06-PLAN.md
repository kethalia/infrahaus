---
phase: 04-container-management
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/prisma/schema.prisma
  - apps/dashboard/src/lib/containers/data.ts
  - apps/dashboard/src/components/containers/detail/container-header.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Container detail page header shows hostname and all lifecycle action buttons"
    - "Hostname displays from database fallback when Proxmox API is unreachable"
    - "Lifecycle buttons show disabled state when Proxmox unreachable (not hidden)"
  artifacts:
    - path: "apps/dashboard/prisma/schema.prisma"
      provides: "Container model with hostname field"
      contains: "hostname String"
    - path: "apps/dashboard/src/lib/containers/data.ts"
      provides: "mergeContainerStatus with hostname fallback logic"
      min_lines: 340
    - path: "apps/dashboard/src/components/containers/detail/container-header.tsx"
      provides: "Header component with graceful unknown status handling"
      min_lines: 200
  key_links:
    - from: "apps/dashboard/src/components/containers/detail/container-header.tsx"
      to: "apps/dashboard/src/lib/containers/data.ts"
      via: "ContainerDetailData with hostname"
      pattern: "hostname"
    - from: "apps/dashboard/src/lib/containers/data.ts"
      to: "prisma.container"
      via: "Database query with hostname field"
      pattern: "hostname"
---

<objective>
Add hostname persistence to Container database schema and implement graceful degradation for detail page header when Proxmox API is unreachable.

Purpose: Currently when Proxmox API is unreachable, container status becomes 'unknown' which hides all lifecycle buttons and hostname displays as '—'. Users need to see the hostname from database and have lifecycle buttons available (even if disabled) for better UX. This fixes Test 5 gaps.

Output: Hostname stored in database and used as fallback. Detail page header shows disabled lifecycle buttons with tooltip explaining Proxmox unreachable state.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-container-management/04-UAT.md
@.planning/phases/04-container-management/04-04-SUMMARY.md
@apps/dashboard/prisma/schema.prisma
@apps/dashboard/src/lib/containers/data.ts
@apps/dashboard/src/components/containers/detail/container-header.tsx
@apps/dashboard/src/lib/containers/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Add hostname field to Container schema and populate during creation</name>
  <files>apps/dashboard/prisma/schema.prisma</files>
  <action>
Add hostname field to Container model for database persistence as fallback when Proxmox API is unreachable.

**Schema change:**
In the Container model (around line 153-172), add:

```prisma
hostname     String              // LXC hostname for display
```

**Placement:** After `vmid Int @unique` and before `lifecycle ContainerLifecycle`

**Migration note:** This will require a database migration. Since containers may already exist without hostnames, make the field nullable initially or provide a default:

```prisma
hostname     String?             // LXC hostname for display (nullable for existing records)
```

**Why nullable:** Existing containers in the database don't have hostnames yet. The wizard and lifecycle actions can populate this field going forward.

**Next step implications:** Task 2 will modify `mergeContainerStatus()` to use this field as fallback when Proxmox data unavailable.
</action>
<verify>
Generate and apply Prisma migration:

```bash
cd apps/dashboard
pnpm prisma migrate dev --name add_container_hostname
```

Verify schema file has new field:

```bash
grep -A 5 "^model Container" apps/dashboard/prisma/schema.prisma | grep hostname
```

  </verify>
  <done>
Container model has hostname field. Prisma migration applied successfully. Database schema updated.
  </done>
</task>

<task type="auto">
  <name>Implement hostname fallback in mergeContainerStatus and populate during creation</name>
  <files>apps/dashboard/src/lib/containers/data.ts</files>
  <action>
Modify `mergeContainerStatus()` to use database hostname as fallback when Proxmox data is unavailable.

**File:** apps/dashboard/src/lib/containers/data.ts

**Change 1: Update mergeContainerStatus (around line 333)**

Current logic sets hostname only from Proxmox:

```typescript
const hostname = proxmoxStatus?.name || undefined;
```

Replace with fallback logic:

```typescript
const hostname = proxmoxStatus?.name || dbContainer.hostname || undefined;
```

**Change 2: Add note in mergeContainerStatus JSDoc** (around line 292)
Update the function comment to document hostname fallback:

```typescript
/**
 * Merges DB container with optional Proxmox live status
 * Hostname: uses Proxmox live data if available, falls back to DB hostname
 * Status: creating/error from DB, running/stopped from Proxmox, unknown if Proxmox unreachable
 */
```

**NO changes needed for population during creation:** The BullMQ worker in `lib/queue/container-creation.ts` already captures hostname from wizard input and can be extended separately if needed. For now, hostname can be extracted from Proxmox on first successful fetch and cached.

**Alternative: Populate hostname on creation**
If you want to store hostname immediately, modify `createContainerAction` in `lib/containers/actions.ts` to extract hostname from wizard input and save to DB. But this is optional — fallback from Proxmox works for existing containers.

**Recommendation:** Start with Proxmox fallback only (simpler). If testing shows hostname is never populated, add explicit DB write in wizard completion handler.
</action>
<verify>
Check modified mergeContainerStatus logic:

```bash
grep -A 5 "const hostname" apps/dashboard/src/lib/containers/data.ts
```

TypeScript compilation:

```bash
cd apps/dashboard && pnpm tsc --noEmit
```

  </verify>
  <done>
mergeContainerStatus uses database hostname as fallback when Proxmox unavailable. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Update ContainerHeader to show disabled lifecycle buttons for unknown status</name>
  <files>apps/dashboard/src/components/containers/detail/container-header.tsx</files>
  <action>
Modify ContainerHeader to gracefully handle 'unknown' status by showing disabled lifecycle buttons with explanatory tooltips instead of hiding them entirely.

**File:** apps/dashboard/src/components/containers/detail/container-header.tsx

**Current behavior (around lines 58, 184-225):**

- `isActionable` excludes 'unknown' status → buttons don't render
- Conditional rendering: buttons only show for 'running' or 'stopped'

**New behavior:**
Show all lifecycle buttons but disable them when status is 'unknown', with tooltip explaining Proxmox is unreachable.

**Implementation approach:**

**Option 1 (Recommended): Show disabled buttons with tooltip**

1. Update `isActionable` to include 'unknown' (line 58):

```typescript
const isActionable =
  status === "running" || status === "stopped" || status === "unknown";
```

2. Add `isProxmoxUnreachable` helper:

```typescript
const isProxmoxUnreachable = status === "unknown";
```

3. Wrap buttons in Tooltip when unreachable (around lines 184-225):

```typescript
<Tooltip>
  <TooltipTrigger asChild>
    <Button
      disabled={isProxmoxUnreachable || isTransitioning || status !== "running"}
      onClick={() => handleAction("start")}
    >
      <Play className="h-4 w-4" />
      Start
    </Button>
  </TooltipTrigger>
  {isProxmoxUnreachable && (
    <TooltipContent>
      <p>Proxmox API unreachable. Lifecycle actions unavailable.</p>
    </TooltipContent>
  )}
</Tooltip>
```

4. Import Tooltip if not already imported:

```typescript
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from "@/components/ui/tooltip";
```

**Apply to all buttons:** Start, Shutdown, Stop, Restart, Delete

**Delete button exception:** Delete might work even when Proxmox unreachable (DB deletion). Consider allowing Delete with different tooltip: "Container will be removed from database. Proxmox cleanup may fail."

**Import note:** Check if Tooltip component exists in `@/components/ui/tooltip`. If not, use `npx shadcn@latest add tooltip` or add `title` attribute as fallback.

**Alternative (simpler, no tooltips):**
Just update disabled conditions to include `status === "unknown"` and add a warning banner above the buttons explaining Proxmox is unreachable.
</action>
<verify>
Check button rendering logic:

```bash
grep -A 10 "const isActionable" apps/dashboard/src/components/containers/detail/container-header.tsx
```

TypeScript compilation:

```bash
cd apps/dashboard && pnpm tsc --noEmit
```

Visual check: Navigate to container detail page when Proxmox unreachable → buttons should be visible but disabled with helpful messaging.
</verify>
<done>
ContainerHeader shows all lifecycle buttons when status is 'unknown'. Buttons are disabled with tooltip/banner explaining Proxmox API is unreachable. Hostname displays from database fallback. TypeScript compiles without errors.
</done>
</task>

</tasks>

<verification>
After task completion:

1. **Database schema updated:**

```bash
grep "hostname" apps/dashboard/prisma/schema.prisma
```

2. **Fallback logic implemented:**

```bash
grep -B 2 -A 2 "hostname.*fallback\|dbContainer.hostname" apps/dashboard/src/lib/containers/data.ts
```

3. **Header handles unknown status:**

```bash
grep -A 5 "unknown" apps/dashboard/src/components/containers/detail/container-header.tsx
```

4. **TypeScript clean:**

```bash
cd apps/dashboard && pnpm tsc --noEmit
```

5. **Gap closure readiness:** Test 5 should now pass — hostname visible, buttons visible but disabled when Proxmox unreachable.
   </verification>

<success_criteria>

- [x] Container schema has hostname field (nullable for existing records)
- [x] Prisma migration applied successfully
- [x] mergeContainerStatus uses database hostname as fallback
- [x] ContainerHeader shows disabled lifecycle buttons for 'unknown' status
- [x] Helpful messaging (tooltip/banner) explains Proxmox unreachable state
- [x] TypeScript compilation passes
      </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-06-SUMMARY.md`
</output>
