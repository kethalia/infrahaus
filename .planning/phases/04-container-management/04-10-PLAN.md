---
phase: 04-container-management
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/lxc/scripts/config-manager/config-manager-helpers.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Template installation creates per-service credential files in directory"
    - "Dashboard monitoring discovers and displays service credentials"
    - "Credential reveal UI shows username/password with copy buttons"
  artifacts:
    - path: "infra/lxc/scripts/config-manager/config-manager-helpers.sh"
      provides: "Updated save_credential() creating per-service files"
      min_lines: 340
      contains: "save_credential.*service_name"
  key_links:
    - from: "infra/lxc/templates/*/container-configs/scripts/*.sh"
      to: "save_credential function"
      via: "save_credential calls with service name parameter"
      pattern: 'save_credential\s+"[^"]+"\s+"[^"]+"'
---

<objective>
Fix credential discovery by updating template installation to create per-service credential files instead of single aggregated file.

Purpose: Service credentials are saved to `/etc/infrahaus/credentials` (single file) during template installation, but monitoring code expects `/etc/infrahaus/credentials/` (directory with separate files per service). This format mismatch prevents credential discovery, making the "Show Credentials" feature non-functional.

Output: Templates create separate credential files per service (e.g., `/etc/infrahaus/credentials/code-server.env`) that monitoring can discover and dashboard can display.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/no-services-with-credentials.md
@infra/lxc/scripts/config-manager/config-manager-helpers.sh
@apps/dashboard/src/lib/containers/monitoring.ts
@apps/dashboard/src/lib/constants/infrastructure.ts
</context>

<tasks>

<task type="auto">
  <name>Update save_credential() to create per-service credential files</name>
  <files>infra/lxc/scripts/config-manager/config-manager-helpers.sh</files>
  <action>
Modify the `save_credential()` function starting at line 338 to accept service name parameter and create separate files per service.

**Replace function signature (line 338-340):**

OLD:

```bash
save_credential() {
    local key="$1"
    local value="$2"
```

NEW:

```bash
save_credential() {
    local service_name="$1"
    local key="$2"
    local value="$3"
```

**Replace function body (lines 341-359):**

OLD creates single file `/etc/infrahaus/credentials`

NEW:

```bash
    local creds_dir="/etc/infrahaus/credentials"
    local service_file="${creds_dir}/${service_name}.env"

    # Ensure directory exists
    mkdir -p "$creds_dir"

    # Create service-specific credential file with header on first write
    if [[ ! -f "$service_file" ]]; then
        {
            echo "# Credentials for ${service_name}"
            echo "# Generated: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "# WARNING: Contains sensitive passwords - keep secure"
            echo ""
        } > "$service_file"
        chmod 600 "$service_file"
    fi

    # Append credential to service file
    echo "${key}=${value}" >> "$service_file"
```

Why this approach:

- Creates `/etc/infrahaus/credentials/` directory (not file)
- Each service gets its own `.env` file (e.g., `code-server.env`, `filebrowser.env`)
- Matches monitoring code's expectation in `monitoring.ts:213-270`
- Preserves KEY=VALUE format (same as before, just in separate files)
- File permissions remain secure (600)

**Update all callsites:**

Search for `save_credential` calls in template scripts and update to pass service name:

```bash
cd infra/lxc/templates
grep -r "save_credential" --include="*.sh"
```

Expected files to update (based on debug session findings):

- `web3-dev/container-configs/scripts/50-vscode-server.sh:78`
- `web3-dev/container-configs/scripts/51-filebrowser.sh:85-86`
- `web3-dev/container-configs/scripts/52-opencode.sh:61`

For each callsite, update pattern:

OLD:

```bash
save_credential "CODE_SERVER_PASSWORD" "$CODE_SERVER_PASSWORD"
```

NEW:

```bash
save_credential "code-server" "CODE_SERVER_PASSWORD" "$CODE_SERVER_PASSWORD"
```

Service names:

- VS Code Server → `"code-server"`
- File Browser → `"filebrowser"`
- OpenCode → `"opencode"`

These names should match the service names used in template service definitions (case-sensitive).
</action>
<verify>
Check function signature updated:

```bash
grep -A 3 "^save_credential()" infra/lxc/scripts/config-manager/config-manager-helpers.sh | grep "service_name"
```

Verify directory creation (not file):

```bash
grep "creds_dir.*credentials\"$" infra/lxc/scripts/config-manager/config-manager-helpers.sh
grep "service_file.*\.env" infra/lxc/scripts/config-manager/config-manager-helpers.sh
```

Check all callsites updated:

```bash
cd infra/lxc/templates && grep -rn "save_credential" --include="*.sh" | grep -v "^.*#"
```

Each callsite should have 3 arguments (service_name, key, value).
</verify>
<done>
`save_credential()` function accepts service_name as first parameter, creates `/etc/infrahaus/credentials/{service}.env` files, all callsites in template scripts updated with service name parameter.
</done>
</task>

</tasks>

<verification>
## Code Verification

```bash
# Verify function signature change
grep -A 5 "^save_credential()" infra/lxc/scripts/config-manager/config-manager-helpers.sh

# Verify directory structure (not single file)
grep "creds_dir\|service_file" infra/lxc/scripts/config-manager/config-manager-helpers.sh

# Count callsites (should be 4-6 across templates)
cd infra/lxc/templates && grep -r "save_credential" --include="*.sh" | grep -v "^.*#" | wc -l

# Verify callsite format (3 parameters)
cd infra/lxc/templates && grep -r "save_credential" --include="*.sh" | head -3
```

## Testing Strategy

**Note:** This fix requires NEW container creation to take effect. Existing containers have old credential format and won't be retroactively fixed.

**To test (after Phase 04 gap closure and Phase 05 planning):**

1. Create a new container from a template with services (e.g., web3-dev)
2. Wait for container creation to complete
3. SSH into container and verify directory structure:
   ```bash
   ls -la /etc/infrahaus/credentials/
   # Should see: code-server.env, filebrowser.env, opencode.env (not single "credentials" file)
   ```
4. Check file contents:
   ```bash
   cat /etc/infrahaus/credentials/code-server.env
   # Should see: CODE_SERVER_PASSWORD=...
   ```
5. In dashboard, navigate to container detail → Services tab
6. Click "Refresh Services"
7. Verify services show "Show Credentials" button
8. Click button, verify credentials expand with copy buttons

**Gap 1 dependency:** Service refresh must work (Gap 1 fix required) before credentials can be discovered.
</verification>

<success_criteria>

- [ ] `save_credential()` function signature changed to accept 3 parameters (service_name, key, value)
- [ ] Function creates directory `/etc/infrahaus/credentials/` (not file)
- [ ] Function creates per-service files `{service_name}.env`
- [ ] File permissions remain 600 (secure)
- [ ] KEY=VALUE format preserved in individual files
- [ ] All callsites in template scripts updated with service name parameter
- [ ] No bash syntax errors in config-manager-helpers.sh
- [ ] New containers created after this fix will have discoverable credentials
- [ ] Monitoring code in dashboard can discover credentials in new containers (testable after Phase 09 fix)
      </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-10-SUMMARY.md`
</output>
