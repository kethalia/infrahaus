---
phase: 04-container-management
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/src/lib/proxmox/schemas.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Lifecycle actions execute successfully from dashboard dropdown menu"
    - "Overview tab displays complete configuration data and live resource usage"
    - "Proxmox API responses with numeric booleans are correctly parsed"
  artifacts:
    - path: "apps/dashboard/src/lib/proxmox/schemas.ts"
      provides: "ContainerStatusSchema with pveBoolean for all boolean fields"
      min_lines: 150
  key_links:
    - from: "apps/dashboard/src/lib/containers/actions.ts"
      to: "apps/dashboard/src/lib/proxmox/schemas.ts"
      via: "ContainerStatusSchema validation"
      pattern: "ContainerStatusSchema"
    - from: "apps/dashboard/src/lib/proxmox/containers.ts"
      to: "apps/dashboard/src/lib/proxmox/schemas.ts"
      via: "getContainer() validation"
      pattern: "ContainerStatusSchema"
---

<objective>
Fix Zod validation errors in ContainerStatusSchema by replacing z.boolean() with pveBoolean helper for all boolean fields that Proxmox API returns as integers (0/1).

Purpose: Proxmox API returns boolean values as integers (0 or 1) but the schema expects true boolean types, causing validation failures that block lifecycle actions and container detail data fetching. This fix unblocks Tests 4, 6, and restores full functionality.

Output: ContainerStatusSchema correctly validates Proxmox API responses with numeric boolean fields.
</objective>

<execution_context>
@/home/coder/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-container-management/04-UAT.md
@.planning/phases/04-container-management/04-01-SUMMARY.md
@.planning/phases/04-container-management/04-04-SUMMARY.md
@apps/dashboard/src/lib/proxmox/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Replace z.boolean() with pveBoolean for Proxmox boolean fields in ContainerStatusSchema</name>
  <files>apps/dashboard/src/lib/proxmox/schemas.ts</files>
  <action>
Fix the ContainerStatusSchema boolean field type mismatches that cause Zod validation errors when Proxmox API returns integers (0/1) instead of true booleans.

**Root cause from UAT:** Line 144 uses `ha.managed: z.boolean()` which fails validation when Proxmox returns 0 or 1.

**Fields to audit and fix:**

1. **ha.managed** (line 144) — BLOCKER: already identified in debug session as returning number
2. **template** — likely returns 0/1 (container is template or not)
3. **onboot** — likely returns 0/1 (start on boot flag)
4. **protection** — likely returns 0/1 (delete protection)
5. **unprivileged** — likely returns 0/1 (unprivileged container flag)

**How to fix:**

- The `pveBoolean` helper already exists at line 191: `z.union([z.boolean(), z.number()]).transform((v) => !!v)`
- Replace each `z.boolean()` with `pveBoolean` for all fields that come from Proxmox API
- Leave `z.boolean().optional()` as `pveBoolean.optional()` to preserve optionality

**DO NOT touch:**

- Fields in other schemas that genuinely expect boolean types from non-Proxmox sources
- The `pveBoolean` helper definition itself (line 191) — it's correct

**Why this fixes the gaps:**

- Gap 1 (Test 4): Lifecycle actions call getContainer() which validates with ContainerStatusSchema. Fixing ha.managed allows validation to pass.
- Gap 3 (Test 6): Same root cause — getContainerDetailData fails due to validation error, making container data unavailable for Overview tab.

**Verification approach:**
After fixing, the schema will accept both boolean and number types for these fields, matching what Proxmox API actually returns.
</action>
<verify>
TypeScript compilation passes:

```bash
cd apps/dashboard && pnpm tsc --noEmit
```

No Zod import errors or type mismatches.
</verify>
<done>
ContainerStatusSchema uses pveBoolean for ha.managed, template, onboot, protection, and unprivileged fields. Schema accepts numeric boolean values (0/1) from Proxmox API. TypeScript compiles without errors.
</done>
</task>

</tasks>

<verification>
After task completion:

1. **Schema validation:** Verify pveBoolean is used for all Proxmox boolean fields

```bash
grep -A 20 "export const ContainerStatusSchema" apps/dashboard/src/lib/proxmox/schemas.ts | grep -E "(template|onboot|protection|unprivileged|ha\.managed)"
```

2. **TypeScript check:** No compilation errors

```bash
cd apps/dashboard && pnpm tsc --noEmit
```

3. **Gap closure readiness:** With schema fixed, lifecycle actions and container detail fetching should work. UAT re-test will verify.
   </verification>

<success_criteria>

- [x] ContainerStatusSchema.ha.managed uses pveBoolean (not z.boolean())
- [x] All other Proxmox boolean fields audited and fixed if needed
- [x] TypeScript compilation passes
- [x] Schema accepts both boolean and number types for validated fields
      </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-05-SUMMARY.md`
</output>
