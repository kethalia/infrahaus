---
phase: 04-container-management
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/src/lib/containers/actions.ts
  - apps/dashboard/src/lib/proxmox/containers.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Service refresh works for DHCP containers (ip=dhcp in net0 config)"
    - "Service refresh works for static IP containers (no regression)"
    - "Error message is clear when IP cannot be determined"
  artifacts:
    - path: "apps/dashboard/src/lib/proxmox/containers.ts"
      provides: "getRuntimeIp function to query Proxmox agent for actual IP"
      exports: ["getRuntimeIp"]
    - path: "apps/dashboard/src/lib/containers/actions.ts"
      provides: "Updated refreshContainerServicesAction with DHCP fallback"
      min_lines: 900
  key_links:
    - from: "apps/dashboard/src/lib/containers/actions.ts"
      to: "apps/dashboard/src/lib/proxmox/containers.ts"
      via: "getRuntimeIp call when extractIpFromNet0 returns null"
      pattern: "getRuntimeIp.*nodeName.*vmid"
---

<objective>
Fix service refresh for DHCP containers by querying Proxmox for runtime-assigned IP addresses.

Purpose: Service monitoring currently fails for containers configured with `ip=dhcp` because the Proxmox config doesn't store the actual assigned IP. This blocks all service discovery, credential reveal, and status monitoring for DHCP containers.

Output: DHCP containers can refresh services successfully by querying Proxmox guest agent for runtime IP as fallback when static IP not found in config.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/service-refresh-dhcp-ip.md
@apps/dashboard/src/lib/containers/actions.ts
@apps/dashboard/src/lib/proxmox/containers.ts
@apps/dashboard/src/lib/proxmox/utils.ts
@apps/dashboard/src/lib/containers/monitoring.ts
</context>

<tasks>

<task type="auto">
  <name>Add getRuntimeIp function to query Proxmox for actual container IP</name>
  <files>apps/dashboard/src/lib/proxmox/containers.ts</files>
  <action>
Add new exported async function `getRuntimeIp(client: ProxmoxClient, nodeName: string, vmid: number): Promise<string | null>` after existing container functions.

Implementation:

1. Query Proxmox guest agent for network interfaces: `GET /api2/json/nodes/{nodeName}/lxc/{vmid}/agent/network-get-interfaces`
2. Parse response to find first non-loopback interface with valid IPv4 address
3. Return the IPv4 address (without CIDR suffix like /24) or null if not found
4. Wrap in try/catch - return null on any error (container stopped, agent not running, etc.)

Why this approach:

- Proxmox guest agent provides runtime network info including DHCP-assigned IPs
- Non-invasive: doesn't require pct exec or SSH to Proxmox host
- Works for both running containers with agent installed
- Graceful degradation: returns null if agent unavailable

Error handling:

- Return null (not throw) on 500 errors (agent not running)
- Return null on 400 errors (invalid vmid)
- Return null if no interfaces found or all are loopback
- Log errors at debug level only (expected for stopped containers)
  </action>
  <verify>
  Add this to verify the function signature exists:

```bash
grep -A 5 "export async function getRuntimeIp" apps/dashboard/src/lib/proxmox/containers.ts
```

Check that it handles errors gracefully (returns null, not throws):

```bash
grep -A 20 "getRuntimeIp" apps/dashboard/src/lib/proxmox/containers.ts | grep "try\|catch\|return null"
```

  </verify>
  <done>
`getRuntimeIp` function exported from `apps/dashboard/src/lib/proxmox/containers.ts`, queries Proxmox agent API, returns string | null, catches all errors gracefully.
  </done>
</task>

<task type="auto">
  <name>Update refreshContainerServicesAction to use runtime IP fallback for DHCP</name>
  <files>apps/dashboard/src/lib/containers/actions.ts</files>
  <action>
Modify `refreshContainerServicesAction` starting at line 867 where it throws error for null IP.

Replace the current error-throwing block:

```typescript
const containerIp = extractIpFromNet0(net0);
if (!containerIp) {
  throw new ActionError(
    "Unable to determine container IP address. DHCP containers require manual IP discovery.",
  );
}
```

With fallback logic:

```typescript
let containerIp = extractIpFromNet0(net0);

// Fallback: Query Proxmox guest agent for runtime IP (DHCP containers)
if (!containerIp) {
  const { getRuntimeIp } = await import("@/lib/proxmox/containers");
  containerIp = await getRuntimeIp(client, nodeName, vmid);

  if (!containerIp) {
    throw new ActionError(
      "Unable to determine container IP address. Ensure container is running and has network connectivity, or configure a static IP.",
    );
  }
}
```

Why dynamic import: `getRuntimeIp` is new function, dynamic import prevents build errors if not yet exported.

Error message improvement: New message is more actionable (tells user what to check) instead of blaming DHCP.
</action>
<verify>
Check the fallback logic exists:

```bash
grep -A 10 "Fallback: Query Proxmox guest agent" apps/dashboard/src/lib/containers/actions.ts
```

Verify error message updated:

```bash
grep "Ensure container is running and has network connectivity" apps/dashboard/src/lib/containers/actions.ts
```

Run TypeScript check:

```bash
cd apps/dashboard && npx tsc --noEmit --project tsconfig.json 2>&1 | grep -i "error\|warning" || echo "No TS errors"
```

  </verify>
  <done>
`refreshContainerServicesAction` tries `extractIpFromNet0` first, falls back to `getRuntimeIp` for DHCP containers, throws actionable error only if both fail. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
## Manual Testing

1. **DHCP Container (Gap Closure):**
   - Navigate to container detail page for a DHCP container (net0 contains `ip=dhcp`)
   - Go to Services tab
   - Click "Refresh Services"
   - Expected: Success toast, services update (or informative error if container truly unreachable)
   - No longer shows: "DHCP containers require manual IP discovery"

2. **Static IP Container (Regression Check):**
   - Navigate to container with static IP (net0 contains `ip=10.x.x.x/24`)
   - Go to Services tab
   - Click "Refresh Services"
   - Expected: Works exactly as before, uses static IP from config

3. **Error Case:**
   - Stop a DHCP container
   - Try to refresh services
   - Expected: Actionable error message (not the old "DHCP containers require..." message)

## Code Verification

```bash
# Verify getRuntimeIp exists and is exported
grep "export.*getRuntimeIp" apps/dashboard/src/lib/proxmox/containers.ts

# Verify fallback logic in action
grep -B 2 -A 8 "getRuntimeIp" apps/dashboard/src/lib/containers/actions.ts

# Verify no TypeScript errors
cd apps/dashboard && npx tsc --noEmit
```

</verification>

<success_criteria>

- [ ] `getRuntimeIp` function queries Proxmox guest agent API for network interfaces
- [ ] Function returns first non-loopback IPv4 address or null
- [ ] Function handles errors gracefully (returns null, never throws)
- [ ] `refreshContainerServicesAction` tries static IP extraction first (preserves fast path)
- [ ] Action falls back to `getRuntimeIp` when static IP not found
- [ ] Action throws actionable error only when both methods fail
- [ ] Error message no longer mentions "DHCP containers require manual IP discovery"
- [ ] TypeScript compilation succeeds
- [ ] DHCP containers can successfully refresh services when running
- [ ] Static IP containers continue to work without regression
      </success_criteria>

<output>
After completion, create `.planning/phases/04-container-management/04-09-SUMMARY.md`
</output>
