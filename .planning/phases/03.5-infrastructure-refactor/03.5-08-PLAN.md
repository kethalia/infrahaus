---
phase: 03.5-infrastructure-refactor
plan: 08
type: execute
wave: 5
depends_on: ["03.5-04", "03.5-06"]
files_modified:
  - apps/dashboard/src/app/(dashboard)/page.tsx
  - apps/dashboard/src/components/containers/container-card.tsx
  - apps/dashboard/src/components/containers/container-dashboard.tsx
  - apps/dashboard/src/app/(dashboard)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Container dashboard shows all containers from all user's nodes"
    - "Each container card displays which node it belongs to"
    - "Dashboard shows prominent banner when no nodes configured"
    - "Container operations are disabled when no nodes configured"
    - "Dashboard page passes userId to getContainersWithStatus"
  artifacts:
    - path: "apps/dashboard/src/app/(dashboard)/page.tsx"
      provides: "Dashboard page with session-aware data fetching"
      contains: "getSessionData"
    - path: "apps/dashboard/src/components/containers/container-card.tsx"
      provides: "Container card with node badge"
      contains: "node"
  key_links:
    - from: "apps/dashboard/src/app/(dashboard)/page.tsx"
      to: "apps/dashboard/src/lib/containers/data.ts"
      via: "getContainersWithStatus(userId) call"
      pattern: "getContainersWithStatus"
    - from: "apps/dashboard/src/app/(dashboard)/page.tsx"
      to: "apps/dashboard/src/lib/session.ts"
      via: "getSessionData for userId"
      pattern: "getSessionData"
---

<objective>
Update the container dashboard to work with multi-node architecture: pass userId for data fetching, show node badge on container cards, add node filtering, and display the no-nodes-configured banner.

Purpose: Per user decisions — container dashboard shows all containers from all nodes with node badge, filterable by node, graceful degradation when no nodes configured.
Output: Dashboard that fetches from all user's nodes, shows node identity, and degrades gracefully.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@.planning/phases/03.5-infrastructure-refactor/03.5-04-SUMMARY.md
@.planning/phases/03.5-infrastructure-refactor/03.5-06-SUMMARY.md
@apps/dashboard/src/app/(dashboard)/page.tsx
@apps/dashboard/src/components/containers/container-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard page and layout for session-aware data fetching</name>
  <files>
    apps/dashboard/src/app/(dashboard)/page.tsx
    apps/dashboard/src/app/(dashboard)/layout.tsx
  </files>
  <action>
**Dashboard page (page.tsx):**
- Import `getSessionData` from `@/lib/session`
- Get userId: `const sessionData = await getSessionData();` — if no session, this shouldn't happen (middleware redirects), but handle gracefully
- Check if user has nodes: `DatabaseService.listNodesForUser(sessionData.username)` — if empty, render NoNodesBanner instead of container data
- Pass userId to `getContainersWithStatus(sessionData.username)` — this function was updated in Plan 04 to accept userId and query all user's nodes
- The dashboard data now includes node information per container — pass this to the container components

**Layout (layout.tsx):**
- The layout renders the AppSidebar. It may need to pass the username for display.
- Check if it already calls `getSessionData()` — if so, use the existing session data
- If the layout currently doesn't get session data, add it: `const sessionData = await getSessionData();` and pass `username={sessionData?.username}` to AppSidebar
- If no session (shouldn't happen due to middleware), render children without username

**Important edge case:** If user is logged in but has no nodes, the dashboard should still render — just show the NoNodesBanner and no container cards. Template browsing and other non-Proxmox features should still work.

The page should NOT redirect to settings — just show the banner with a link to settings. Per user decision: "templates and non-node features still work, container operations disabled with clear messaging."
  </action>
  <verify>
1. Dashboard page imports and calls getSessionData
2. Dashboard passes userId to getContainersWithStatus
3. NoNodesBanner shows when user has no nodes
4. Layout passes username to AppSidebar
5. No TypeScript errors in page.tsx and layout.tsx
  </verify>
  <done>
Dashboard page uses session-aware data fetching with userId. Shows NoNodesBanner when no nodes configured. Layout passes username for sidebar display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add node badge to container cards and node filtering</name>
  <files>
    apps/dashboard/src/components/containers/container-card.tsx
    apps/dashboard/src/components/containers/container-dashboard.tsx
  </files>
  <action>
**Container card (container-card.tsx):**
- The card receives container data which now includes the `node` relation (name, host)
- Add a node badge: shadcn `<Badge variant="outline">` showing the node name (e.g., "pve-node-1")
- Position: in the card header area, next to the container hostname/VMID
- Keep it subtle — outline variant, small size. This is informational, not primary.
- Ensure the badge only shows when user has multiple nodes (or always show it — simpler and consistent)

**Container dashboard component (if exists, or the dashboard portion of page.tsx):**
- Add node filter: If user has multiple nodes, show a filter bar with node name pills/buttons
- Use shadcn ToggleGroup or simple Button group to filter by node
- "All Nodes" option shows all containers (default)
- Individual node options filter to that node only
- Filter operates on the already-fetched data (client-side filtering, no additional API calls)
- If user has only one node, don't show the filter (unnecessary)

**Data shape:** The `ContainerWithStatus` type (from data.ts) should now include node info. Check what `getContainersWithStatus` returns — it may need to include `node: { id, name }` in the result. If not already included, update the type and query in `getContainersWithStatus` to include the node name.

Per user decision: "Container dashboard shows all containers from all nodes, filterable by node — node badge on each container card."
  </action>
  <verify>
1. Container cards show node name badge
2. If multiple nodes, filter bar appears
3. Filtering works client-side (selecting a node shows only that node's containers)
4. "All Nodes" option shows everything
5. Single-node users don't see the filter
  </verify>
  <done>
Container cards display node badge. Dashboard has node filter when multiple nodes exist. Client-side filtering by node works.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete dashboard with multi-node support</name>
  <what-built>Dashboard with session-aware data fetching, node badges on containers, node filtering, and graceful degradation banner.</what-built>
  <how-to-verify>
1. Log out and verify redirect to /login
2. Log in with Proxmox credentials
3. If no nodes: verify NoNodesBanner shows on dashboard with link to settings
4. Add a node in /settings/nodes
5. Navigate to dashboard — verify containers load from that node
6. Verify each container card shows the node name badge
7. If possible, add a second node and verify filter bar appears
8. Verify template pages still work (not dependent on nodes)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Dashboard fetches containers using session userId
2. NoNodesBanner appears when no nodes configured
3. Container cards show node badge
4. Node filter works for multi-node users
5. Template/package pages unaffected by auth changes
6. Login/logout flow works end-to-end
</verification>

<success_criteria>
- Dashboard shows all containers from all user's nodes
- Node badge visible on each container card
- Node filter available for multi-node users
- No-nodes banner shows with link to settings
- Full login→dashboard→settings flow works
- Non-Proxmox pages (templates) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-08-SUMMARY.md`
</output>
