---
phase: 03.5-infrastructure-refactor
plan: 01
subsystem: database
tags: [prisma, postgresql, schema-migration, multi-user]

# Dependency graph
requires:
  - phase: 04-container-management
    provides: Existing ProxmoxNode and Container Prisma models
provides:
  - userId field on ProxmoxNode for per-user node scoping
  - isDefault and sshPassword fields on ProxmoxNode
  - Compound unique constraint (userId, name) on ProxmoxNode
  - rootPassword removed from Container model
  - User-scoped DatabaseService methods (listNodesForUser, getDefaultNodeForUser, etc.)
affects:
  - 03.5-02 (auth refactor needs userId-scoped queries)
  - 03.5-03 (VMID cache needs node queries)
  - 03.5-04 (Proxmox client migration uses getNodeById)
  - 03.5-05 (worker migration uses DB-based node resolution)
  - 03.5-06 (settings page uses getUserNodesWithContainerCount, createNode, setDefaultNode)
  - 03.5-07 (wizard updates use new createContainer without rootPassword)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Compound unique constraints for per-user scoping (@@unique([userId, name]))"
    - "Transaction-based default swap pattern (setDefaultNode)"

key-files:
  created:
    - "apps/dashboard/prisma/migrations/20260220000000_infra_refactor/migration.sql"
  modified:
    - "apps/dashboard/prisma/schema.prisma"
    - "apps/dashboard/src/lib/db.ts"

key-decisions:
  - "Clean data migration: DELETE existing containers/nodes rather than backfill userId — no production users, dev database only"
  - "getNodeById remains unscoped by userId — worker receives nodeId directly, no session context"
  - "setDefaultNode uses transaction to atomically unset all + set one (no partial unique index needed)"

patterns-established:
  - "userId-scoped queries: all node list/lookup methods require userId parameter"
  - "Compound unique lookup: getNodeByName uses userId_name compound key"

# Metrics
duration: 14min
completed: 2026-02-20
---

# Phase 3.5 Plan 01: Schema Migration + DB Service Refactor Summary

**Prisma schema updated with userId/isDefault/sshPassword on ProxmoxNode, rootPassword removed from Container, and DatabaseService refactored with userId-scoped node query methods**

## Performance

- **Duration:** 14 min
- **Started:** 2026-02-20T19:25:31Z
- **Completed:** 2026-02-20T19:39:37Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- ProxmoxNode model now supports multi-user ownership with userId field, isDefault flag, and optional sshPassword for pct exec
- Unique constraint changed from global name to compound (userId, name) — each user can have unique node names
- rootPassword completely removed from Container model (clean break — Proxmox API still sets password, we just don't store it)
- DatabaseService has 5 new userId-scoped methods: listNodesForUser, getDefaultNodeForUser, getUserNodesWithContainerCount, setDefaultNode, getNodeByName(userId, name)
- createContainer no longer requires rootPassword in its data parameter

## Task Commits

Each task was committed atomically:

1. **Task 1: Prisma schema migration — ProxmoxNode and Container models** - `590cf0c` (feat)
2. **Task 2: Update DatabaseService node methods for userId scoping** - `ec6fe12` (feat)

## Files Created/Modified
- `apps/dashboard/prisma/schema.prisma` - Updated ProxmoxNode (userId, isDefault, sshPassword, compound unique) and Container (removed rootPassword)
- `apps/dashboard/prisma/migrations/20260220000000_infra_refactor/migration.sql` - SQL migration with data cleanup + schema changes
- `apps/dashboard/src/lib/db.ts` - Refactored node methods for userId scoping, added new query methods, removed rootPassword from createContainer

## Decisions Made
- **Clean data migration approach:** Since this is a dev database with no production users, the migration DELETEs all existing containers and nodes before adding the required userId column as NOT NULL. This avoids nullable→backfill→alter complexity.
- **getNodeById stays unscoped:** The worker process receives nodeId in job data and has no session context. It resolves node credentials directly by ID, which is correct since the container→node FK already validates the relationship.
- **Transaction-based default swap:** setDefaultNode uses a Prisma transaction to unset all user's defaults then set one, avoiding the complexity of PostgreSQL partial unique indexes (which Prisma doesn't natively support).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Database server at 192.168.0.31:54613 was unreachable, so `prisma migrate dev` couldn't auto-generate the migration SQL. Created the migration file manually with correct SQL matching the schema changes. The migration will be applied when the database is accessible (via `prisma migrate deploy` or `prisma migrate dev`).
- Prisma client is gitignored (generated at build time via postinstall hook), so only the schema and migration SQL were committed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Schema foundation is complete — all subsequent plans (03.5-02 through 03.5-08) can proceed
- Ready for 03.5-02-PLAN.md (Auth refactor: session-based authActionClient)
- Expected downstream errors exist in actions.ts and helpers.ts (rootPassword refs, listNodes() calls, getNodeByName() arity) — these will be fixed in plans 03.5-04 and 03.5-07

## Self-Check: PASSED

---
*Phase: 03.5-infrastructure-refactor*
*Completed: 2026-02-20*
