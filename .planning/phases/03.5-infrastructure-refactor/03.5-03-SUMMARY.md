---
phase: 03.5-infrastructure-refactor
plan: 03
subsystem: infra
tags: [redis, vmid, proxmox, server-actions, zod, encryption, crud]

requires:
  - phase: 03.5-01
    provides: "ProxmoxNode model with userId, sshPassword, isDefault; DatabaseService node methods"
  - phase: 03.5-02
    provides: "authActionClient with session-based userId in ctx"
provides:
  - "Redis VMID cache module (refresh, check, invalidate, get) for wizard integration"
  - "Node CRUD server actions with connection testing for settings page"
  - "Zod schemas for node forms (shared client/server)"
affects: ["03.5-06", "03.5-07"]

tech-stack:
  added: []
  patterns:
    - "VMID cache as Redis SET with pipeline-based atomic refresh"
    - "Connection test before node save (hit /version endpoint)"
    - "Auto-default first node for user"
    - "Ownership verification helper for node mutations"

key-files:
  created:
    - "apps/dashboard/src/lib/vmid-cache.ts"
    - "apps/dashboard/src/lib/nodes/schemas.ts"
    - "apps/dashboard/src/lib/nodes/actions.ts"
  modified:
    - "apps/dashboard/src/lib/constants/infrastructure.ts"

key-decisions:
  - "VMID cache uses Redis SET (SADD/SISMEMBER/SMEMBERS) with 5-minute TTL per node"
  - "Connection test via /version endpoint before persisting any node credentials"
  - "updateNodeAction decrypts existing tokenSecret for connection test when no new secret provided"
  - "sshPassword update semantics: provided=encrypt, empty string=clear (null), omitted=keep existing"

patterns-established:
  - "verifyOwnership helper: fetch node by ID, check userId match, throw ActionError if mismatch"
  - "testConnection helper: create temporary ProxmoxClient with plaintext creds, hit /version"

duration: 3min
completed: 2026-02-20
---

# Phase 3.5 Plan 03: VMID Cache + Node CRUD Actions Summary

**Redis VMID cache module with SET-based per-node caching and 5 node management server actions with Zod validation, connection testing, and auto-default logic**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-20T20:30:25Z
- **Completed:** 2026-02-20T20:34:09Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- VMID cache module with 4 functions (refresh, check, invalidate, get) using Redis SET data structure
- Node CRUD server actions (create, update, delete, setDefault, testConnection) with auth, ownership, and connection testing
- Zod schemas for node forms shared between client and server validation
- Auto-default logic: first node added for a user becomes the default
- Delete protection: prevents node deletion when containers exist, promotes next node to default

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Redis VMID cache module** - `4439f99` (feat)
2. **Task 2: Create node management schemas and server actions** - `f2d382f` (feat)

## Files Created/Modified

- `apps/dashboard/src/lib/vmid-cache.ts` — Redis VMID cache: refreshVmidCache, isVmidTaken, invalidateVmidCache, getCachedVmids
- `apps/dashboard/src/lib/nodes/schemas.ts` — Zod schemas: createNodeSchema, updateNodeSchema, deleteNodeSchema, setDefaultNodeSchema
- `apps/dashboard/src/lib/nodes/actions.ts` — Server actions: createNodeAction, updateNodeAction, deleteNodeAction, setDefaultNodeAction, testNodeConnectionAction
- `apps/dashboard/src/lib/constants/infrastructure.ts` — Added VMID_CACHE_PREFIX and VMID_CACHE_TTL_S constants

## Decisions Made

- VMID cache uses Redis SET with pipeline (DEL → SADD → EXPIRE) for atomic refresh — more efficient than HASH for membership checks
- Connection test uses /version endpoint (lightweight, always available) instead of /nodes (heavier)
- updateNodeAction decrypts existing tokenSecret from DB when no new secret provided — ensures connection test always runs with valid credentials
- sshPassword update has three states: provided string → encrypt and store, empty string → clear to null, undefined → keep existing value
- vmid-cache.ts has no "server-only" import — worker process needs it for cache invalidation after container create/delete

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] VMID cache constants already existed in infrastructure.ts**

- **Found during:** Task 1
- **Issue:** Plan said to add VMID_CACHE_PREFIX and VMID_CACHE_TTL_S to infrastructure.ts, but they were already present on disk (added during 03.5-01 but not committed with that plan's squash commit)
- **Fix:** Included the uncommitted constants in this task's commit since they belong to vmid-cache functionality
- **Files modified:** apps/dashboard/src/lib/constants/infrastructure.ts
- **Verification:** TypeScript compiles, constants imported successfully in vmid-cache.ts
- **Committed in:** 4439f99

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor — constants were already correct, just needed to be committed.

## Issues Encountered

None

## User Setup Required

None — no external service configuration required.

## Next Phase Readiness

- VMID cache module ready for wizard integration (Plan 07)
- Node CRUD actions ready for settings page UI (Plan 06)
- All new modules follow established patterns (authActionClient, DatabaseService, encrypt/decrypt)
- Ready for Plan 04 (Proxmox client migration)

## Self-Check: PASSED

---
*Phase: 03.5-infrastructure-refactor*
*Completed: 2026-02-20*
