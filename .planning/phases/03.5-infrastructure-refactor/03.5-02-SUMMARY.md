---
phase: 03.5-infrastructure-refactor
plan: "02"
subsystem: authentication
tags: [session, auth, middleware, proxmox, login, iron-session, redis]

dependency_graph:
  requires: ["03.5-01"]
  provides:
    - "Session-based authActionClient with userId in context"
    - "Real login/logout actions using Proxmox ticket auth"
    - "Route protection middleware"
    - "Login form with host/port/username/password/realm"
  affects: ["03.5-03", "03.5-04", "03.5-05", "03.5-06", "03.5-07", "03.5-08"]

tech_stack:
  added: []
  patterns:
    - "authActionClient session middleware providing userId in ctx"
    - "actionClient (unauthenticated) for login flow"
    - "Cookie-based route protection in Edge middleware"

key_files:
  created: []
  modified:
    - "apps/dashboard/src/lib/safe-action.ts"
    - "apps/dashboard/src/lib/auth/actions.ts"
    - "apps/dashboard/src/middleware.ts"
    - "apps/dashboard/src/app/login/page.tsx"

decisions:
  - "authActionClient reads session via getSessionData() and provides userId (Proxmox username) in ctx"
  - "loginAction uses actionClient (not authActionClient) since user isn't authenticated yet"
  - "Middleware checks SESSION_COOKIE_NAME constant for cookie presence (Edge-safe, no Redis/Node)"
  - "Login form host+port on same row (host flex-1, port w-24) for compact layout"

metrics:
  duration: "~2 minutes"
  completed: "2026-02-20"
---

# Phase 03.5 Plan 02: Session-Based Auth Flow Summary

**One-liner:** Replaced env-var auth with real session-based auth — authActionClient checks Redis session, login authenticates via Proxmox ticket API, middleware protects routes.

## What Was Done

### Task 1: Refactor authActionClient to session-based auth with userId context
- Removed `process.env.PVE_HOST` and `process.env.PVE_ROOT_PASSWORD` checks from `authActionClient`
- Added `getSessionData()` import from `@/lib/session`
- `authActionClient` now validates Redis-backed session and provides `userId: sessionData.username` in context
- Base `actionClient` kept unchanged for unauthenticated actions (login)
- `ActionError` class kept unchanged

### Task 2: Re-enable login/logout actions, route protection, and login form
- **login action:** Uses `actionClient` (unauthenticated), accepts `host/port/username/password/realm`, calls `login()` from `@/lib/proxmox/auth`, creates Redis session via `createSession()`
- **logout action:** Uses `authActionClient`, calls `destroySession()`, redirects to `/login`
- **middleware:** Allows `/login`, `/_next/`, `/api/auth/` without session; redirects all other unauthenticated requests to `/login`; uses `SESSION_COOKIE_NAME` constant
- **login page:** Added host and port fields (same row), kept username/password, kept realm as Select dropdown; wired to `loginAction` via `useAction`

## Task Commits

| Task | Name | Commit | Key Files |
|------|------|--------|-----------|
| 1 | Refactor authActionClient to session-based auth | `017c4f9` | `safe-action.ts` |
| 2 | Real login/logout, middleware, login form | `4fe73e9` | `auth/actions.ts`, `middleware.ts`, `login/page.tsx` |

## Deviations from Plan

None — plan executed exactly as written.

## Verification Results

1. ✅ `safe-action.ts` has session-based `authActionClient` with `userId` in ctx
2. ✅ `auth/actions.ts` has real login (Proxmox API + session creation) and logout (session destruction)
3. ✅ `middleware.ts` redirects unauthenticated users to `/login`
4. ✅ Zero references to `PVE_HOST` or `PVE_ROOT_PASSWORD` in any modified files
5. ✅ Login page presents host, port, username, password, and realm fields

## Key Links Verified

- `safe-action.ts` → `session.ts` via `getSessionData()` call in middleware ✅
- `auth/actions.ts` → `proxmox/auth` via `login()` call for Proxmox ticket ✅
- `auth/actions.ts` → `session.ts` via `createSession()` / `destroySession()` calls ✅

## Next Phase Readiness

- All downstream actions now receive `userId` in ctx (from `sessionData.username`)
- Plan 03.5-03 (Proxmox client factory) can now use `userId` to resolve per-user node connections
- Session flow: login → Proxmox ticket → Redis session → iron-session cookie → authActionClient → userId in ctx

## Self-Check: PASSED
