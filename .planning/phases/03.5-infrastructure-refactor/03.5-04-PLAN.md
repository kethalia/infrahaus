---
phase: 03.5-infrastructure-refactor
plan: 04
type: execute
wave: 3
depends_on: ["03.5-01", "03.5-02"]
files_modified:
  - apps/dashboard/src/lib/proxmox/index.ts
  - apps/dashboard/src/lib/containers/actions.ts
  - apps/dashboard/src/lib/containers/data.ts
  - apps/dashboard/src/lib/containers/schemas.ts
autonomous: true

must_haves:
  truths:
    - "getProxmoxClient() function is removed entirely"
    - "All container actions resolve Proxmox client from DB node records"
    - "Container actions receive userId from ctx and use it to resolve nodes"
    - "rootPassword is removed from container creation schema and action"
    - "No references to PVE_HOST, PVE_PORT, PVE_ROOT_PASSWORD, or PVE_NODE in containers/"
  artifacts:
    - path: "apps/dashboard/src/lib/proxmox/index.ts"
      provides: "Clean proxmox module with only DB-based client factories"
      contains: "createProxmoxClientFromNode"
    - path: "apps/dashboard/src/lib/containers/actions.ts"
      provides: "Container actions using DB-based Proxmox auth"
      contains: "ctx.userId"
    - path: "apps/dashboard/src/lib/containers/data.ts"
      provides: "Data layer using DB-based Proxmox auth"
      contains: "createProxmoxClientFromNode"
    - path: "apps/dashboard/src/lib/containers/schemas.ts"
      provides: "Container schemas without rootPassword"
  key_links:
    - from: "apps/dashboard/src/lib/containers/actions.ts"
      to: "apps/dashboard/src/lib/db.ts"
      via: "DatabaseService.getDefaultNodeForUser for node resolution"
      pattern: "getDefaultNodeForUser|getNodeById"
    - from: "apps/dashboard/src/lib/containers/data.ts"
      to: "apps/dashboard/src/lib/proxmox/index.ts"
      via: "createProxmoxClientFromNode for API calls"
      pattern: "createProxmoxClientFromNode"
---

<objective>
Migrate all Proxmox client usage in containers/actions.ts and containers/data.ts from env-var-based getProxmoxClient() to DB-based createProxmoxClientFromNode(). Remove rootPassword from schemas and creation flow.

Purpose: This is the core migration — 8 call sites in the two most important files. After this, container operations use DB-stored credentials exclusively.
Output: All container actions and data functions use DB-based Proxmox auth. getProxmoxClient() is deleted.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@.planning/phases/03.5-infrastructure-refactor/03.5-01-SUMMARY.md
@.planning/phases/03.5-infrastructure-refactor/03.5-02-SUMMARY.md
@apps/dashboard/src/lib/proxmox/index.ts
@apps/dashboard/src/lib/containers/actions.ts
@apps/dashboard/src/lib/containers/data.ts
@apps/dashboard/src/lib/containers/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up proxmox/index.ts — remove env-var client and deprecated functions</name>
  <files>
    apps/dashboard/src/lib/proxmox/index.ts
  </files>
  <action>
Remove all env-var-based client code from proxmox/index.ts:

1. **Delete** the entire `getProxmoxClient()` function (lines ~47-104) — the cached ticket, env-var reads, all of it
2. **Delete** the `cachedTicket` variable and its type
3. **Delete** the `createProxmoxClientFromTicket()` function (deprecated)
4. **Remove** imports that are only used by deleted code: `login` from `./auth`, `DEFAULT_PVE_PORT`, `TICKET_CACHE_BUFFER_MS`, `ProxmoxTicketCredentials`
5. **Keep** `createProxmoxClientFromNode()` — this is now the ONLY way to get a Proxmox client
6. **Keep** `createProxmoxClient()` (generic config-based factory) — still useful
7. **Keep** all re-exports (types, schemas, errors, modules)

Add a new convenience function:
```typescript
/**
 * Get a Proxmox client for a specific node by ID.
 * Loads the node from DB and creates an authenticated client.
 */
export async function getProxmoxClientForNode(nodeId: string): Promise<ProxmoxClient> {
  const node = await DatabaseService.getNodeById(nodeId);
  if (!node) throw new Error(`Proxmox node not found: ${nodeId}`);
  return createProxmoxClientFromNode(node);
}
```

Import `DatabaseService` from `@/lib/db` for this.

**Important:** This file must NOT have "server-only" — the worker process imports from it.
  </action>
  <verify>
1. `getProxmoxClient()` function no longer exists
2. `createProxmoxClientFromTicket()` function no longer exists
3. `cachedTicket` variable no longer exists
4. No `process.env.PVE_` references in the file
5. `createProxmoxClientFromNode()` still exists
6. `getProxmoxClientForNode()` (new) exists
7. File compiles: `npx tsc --noEmit` (may have errors elsewhere from removed getProxmoxClient)
  </verify>
  <done>
proxmox/index.ts is clean — only DB-based client creation remains. getProxmoxClient() and createProxmoxClientFromTicket() are deleted. New getProxmoxClientForNode() convenience function added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate containers/schemas.ts and containers/actions.ts</name>
  <files>
    apps/dashboard/src/lib/containers/schemas.ts
    apps/dashboard/src/lib/containers/actions.ts
  </files>
  <action>
Migrate schemas and all 5 call sites in actions.ts. All actions receive `ctx.userId` from authActionClient (Plan 02).

**containers/schemas.ts:**
- Remove `rootPassword` field from the container creation schema
- Remove `confirmPassword` field if it exists
- Keep all other fields

**containers/actions.ts — migrate each call site:**

1. **`getOrCreateNode()` helper (line ~152)** — This function auto-creates a node from env vars. **Delete this entire function.** It's replaced by user-managed nodes from the settings page. Anywhere that called it should now receive `nodeId` as a parameter or resolve the user's default node.

2. **`getWizardData()` (line ~204)** — Currently calls `getProxmoxClient()`. Refactor to accept `nodeId: string` parameter. Resolve the node from DB: `DatabaseService.getNodeById(nodeId)`, then `createProxmoxClientFromNode(node)`. Remove `process.env.PVE_NODE` reference — get the node name from the DB record (`node.name`). If no nodeId provided, return early with a "no node" indicator so the wizard can show the graceful degradation banner.

3. **`createContainerAction` VMID check (line ~453)** — Currently calls `getProxmoxClient()` to check if VMID exists. Change to: resolve node from `data.nodeId` (which the wizard now passes), `createProxmoxClientFromNode()`. Remove `encrypt(data.rootPassword)` — no longer stored. Remove `rootPassword` from the `DatabaseService.createContainer()` call. Add `invalidateVmidCache(node.id)` after successful container creation (import from vmid-cache.ts).

4. **`getContainerContext()` helper (line ~584)** — Currently calls `getProxmoxClient()`. Refactor: the container record includes `nodeId` from DB. Load the node via `container.node` (already included from `getContainerById`), then `createProxmoxClientFromNode(container.node)`. No need for userId here since we're resolving from the container's own node.

5. **`refreshContainerServicesAction` (line ~881)** — Currently calls `getProxmoxClient()` AND uses `PVE_HOST`/`PVE_ROOT_PASSWORD` for SSH. Refactor the Proxmox client part: resolve from container's node. For SSH: get the node from the container, use `node.host` and `decrypt(node.sshPassword)` for SSH credentials. If `node.sshPassword` is null, throw ActionError("SSH password not configured for this node. Update node settings.").

**Remove all imports of `getProxmoxClient` from actions.ts.** Add imports for `createProxmoxClientFromNode`, `DatabaseService`, `decrypt` as needed.

**Remove ALL `process.env.PVE_HOST`, `process.env.PVE_PORT`, `process.env.PVE_ROOT_PASSWORD`, `process.env.PVE_NODE` references from actions.ts.**
  </action>
  <verify>
Run `grep -r "getProxmoxClient\b" apps/dashboard/src/lib/containers/actions.ts` — should return 0 results.
Run `grep -r "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT\|PVE_NODE" apps/dashboard/src/lib/containers/actions.ts` — should return 0 results.
Run `grep -r "rootPassword" apps/dashboard/src/lib/containers/schemas.ts` — should return 0 results.
Read containers/actions.ts and verify `ctx.userId` is used for node resolution.
  </verify>
  <done>
5 call sites in actions.ts migrated from env-var to DB-based auth. getOrCreateNode() deleted. rootPassword removed from schemas. No env-var references remain in actions.ts or schemas.ts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate containers/data.ts to DB-based Proxmox auth</name>
  <files>
    apps/dashboard/src/lib/containers/data.ts
  </files>
  <action>
Migrate the 2 remaining call sites in data.ts to DB-based auth.

1. **`getContainersWithStatus()` (line ~153)** — Currently calls `getProxmoxClient()`. Refactor: this function lists ALL containers from ALL nodes for the dashboard. Change to: accept `userId: string` parameter. Get all user's nodes via `DatabaseService.listNodesForUser(userId)`. For each node, create a client via `createProxmoxClientFromNode(node)` and fetch containers in parallel. Merge results.

2. **`getContainerDetailData()` (line ~274)** — Currently calls `getProxmoxClient()`. Refactor: the container record has a `node` relation. Use `createProxmoxClientFromNode(container.node)`.

**Remove all imports of `getProxmoxClient` from data.ts.** Add imports for `createProxmoxClientFromNode`, `DatabaseService` as needed.

**Remove ALL `process.env.PVE_HOST`, `process.env.PVE_PORT`, `process.env.PVE_ROOT_PASSWORD`, `process.env.PVE_NODE` references from data.ts.**

**Important:** `getContainersWithStatus` signature changes — callers (page.tsx) will need to pass userId. The page.tsx will get userId from session in its RSC. This is a breaking change that's expected — Plan 08 (dashboard updates) will fix the page. For now, focus on making data.ts internally consistent.
  </action>
  <verify>
Run `grep -r "getProxmoxClient\b" apps/dashboard/src/lib/containers/data.ts` — should return 0 results.
Run `grep -r "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT\|PVE_NODE" apps/dashboard/src/lib/containers/data.ts` — should return 0 results.
Read containers/data.ts and verify it uses createProxmoxClientFromNode.
Read containers/data.ts and verify getContainersWithStatus accepts userId parameter.
  </verify>
  <done>
Both data.ts call sites migrated. getContainersWithStatus accepts userId for multi-node queries. getContainerDetailData uses container's node relation. No env-var references remain in data.ts.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "getProxmoxClient\b" apps/dashboard/src/lib/` returns only the definition in proxmox/index.ts (getProxmoxClientForNode)
2. `grep -rn "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT\|PVE_NODE" apps/dashboard/src/lib/` returns 0 results
3. `grep -rn "rootPassword" apps/dashboard/src/lib/` returns 0 results
4. proxmox/index.ts only has DB-based client factories
5. containers/actions.ts uses ctx.userId + DatabaseService for node resolution
6. containers/data.ts uses createProxmoxClientFromNode
</verification>

<success_criteria>
- getProxmoxClient() deleted, no env-var Proxmox auth anywhere in lib/
- All 8 container call sites use DB-based node resolution
- rootPassword fully removed from container schemas and actions
- VMID cache invalidation wired into container creation
- SSH in refreshContainerServicesAction uses node.sshPassword from DB
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-04-SUMMARY.md`
</output>
