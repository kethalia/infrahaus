---
phase: 03.5-infrastructure-refactor
plan: 04
subsystem: infra
tags: [proxmox, auth, migration, containers, db-credentials]

# Dependency graph
requires:
  - phase: 03.5-01
    provides: "DatabaseService with userId-scoped node methods (listNodesForUser, getDefaultNodeForUser)"
  - phase: 03.5-02
    provides: "authActionClient with ctx.userId from Redis session"
  - phase: 03.5-03
    provides: "VMID cache module (invalidateVmidCache) for cache invalidation on create/delete"
provides:
  - "All container actions and data functions use DB-based Proxmox auth exclusively"
  - "getProxmoxClient() deleted — no env-var-based Proxmox auth remains"
  - "rootPassword removed from container schemas and creation flow"
  - "getProxmoxClientForNode() convenience function for node-by-ID lookups"
  - "Multi-node parallel container status fetching in getContainersWithStatus()"
affects: [03.5-06, 03.5-07, 03.5-08]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "DB-based Proxmox client resolution: createProxmoxClientFromNode(container.node)"
    - "userId-scoped node resolution for multi-node queries"
    - "Per-node parallel fetch with graceful individual node failure handling"

key-files:
  modified:
    - "apps/dashboard/src/lib/proxmox/index.ts"
    - "apps/dashboard/src/lib/containers/actions.ts"
    - "apps/dashboard/src/lib/containers/data.ts"
    - "apps/dashboard/src/lib/containers/schemas.ts"
    - "apps/dashboard/src/app/(dashboard)/page.tsx"
    - "apps/dashboard/src/app/(dashboard)/containers/new/page.tsx"

key-decisions:
  - "getContainersWithStatus() iterates user's DB nodes in parallel rather than using cluster listNodes API"
  - "getContainerDetailData() resolves node from container's DB relation (no userId needed)"
  - "SSH credentials for service refresh come from node.sshPassword (decrypted) instead of env vars"
  - "VMID cache invalidated on both container create and delete operations"
  - "Dashboard page.tsx gets session and passes userId to data layer (same pattern as wizard page)"

patterns-established:
  - "Container→Node resolution: container.node is always available from DatabaseService queries (includes node:true)"
  - "Multi-node dashboard pattern: parallel fetch from all user nodes with per-node error isolation"

# Metrics
duration: ~45min (across two sessions)
completed: 2026-02-20
---

# Phase 3.5 Plan 04: Container Actions & Data Migration Summary

**Migrated all 8 Proxmox client call sites in containers/ from env-var getProxmoxClient() to DB-based createProxmoxClientFromNode(), deleted getProxmoxClient() entirely, removed rootPassword from schemas**

## Performance

- **Duration:** ~45 min (across two sessions)
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments

- Deleted `getProxmoxClient()` and all env-var-based Proxmox auth from proxmox/index.ts
- Migrated all 8 container call sites (5 in actions.ts, 2 in data.ts, plus getOrCreateNode deletion) to DB-based auth
- Removed `rootPassword` from container schemas (base, config, and input schemas)
- Updated dashboard page and wizard page RSCs to pass userId to data layer
- Added VMID cache invalidation on container create and delete
- SSH in `refreshContainerServicesAction` now uses `node.sshPassword` from DB

## Task Commits

Each task was committed atomically:

1. **Task 1: Clean up proxmox/index.ts** - `2638e27` (feat)
2. **Task 2: Migrate containers/schemas.ts and containers/actions.ts** - `e2e4b3f` (feat)
3. **Task 3: Migrate containers/data.ts to DB-based Proxmox auth** - `92a2c60` (feat)

## Files Created/Modified

- `apps/dashboard/src/lib/proxmox/index.ts` — Cleaned: deleted getProxmoxClient(), createProxmoxClientFromTicket(), cachedTicket; added getProxmoxClientForNode()
- `apps/dashboard/src/lib/containers/actions.ts` — 5 call sites migrated: getWizardData, createContainerAction, getContainerContext, refreshContainerServicesAction; deleted getOrCreateNode()
- `apps/dashboard/src/lib/containers/data.ts` — getContainersWithStatus() accepts userId + multi-node parallel fetch; getContainerDetailData() uses container.node
- `apps/dashboard/src/lib/containers/schemas.ts` — rootPassword and confirmPassword removed from all schemas
- `apps/dashboard/src/app/(dashboard)/page.tsx` — Gets session, passes userId to getContainersWithStatus()
- `apps/dashboard/src/app/(dashboard)/containers/new/page.tsx` — Gets session, passes userId to getWizardData()

## Decisions Made

- **getContainersWithStatus multi-node strategy:** Iterates user's DB nodes in parallel rather than calling cluster `listNodes` API. Each node creates its own client via `createProxmoxClientFromNode()`. Per-node failures are isolated (logged, return empty array) so one offline node doesn't break the dashboard.
- **getContainerDetailData no userId needed:** Container's DB record already has `node` relation (DatabaseService queries include `node: true`), so we resolve the client directly from `container.node` without needing the user's session.
- **SSH credentials from DB:** `refreshContainerServicesAction` now uses `decrypt(container.node.sshPassword)` for SSH instead of `process.env.PVE_ROOT_PASSWORD`. Throws ActionError if `sshPassword` is null.
- **Dashboard page session check:** Added `getSessionData()` + redirect to login, matching the pattern already established in the wizard page.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Updated dashboard page.tsx caller for getContainersWithStatus**
- **Found during:** Task 3 (data.ts migration)
- **Issue:** Plan noted signature change to `getContainersWithStatus(userId)` but said "Plan 08 will fix the page." However, the caller would fail immediately without the userId argument.
- **Fix:** Updated `app/(dashboard)/page.tsx` to get session data and pass `session.username` to `getContainersWithStatus()`, following the same pattern used in the wizard page.
- **Files modified:** `apps/dashboard/src/app/(dashboard)/page.tsx`
- **Committed in:** `92a2c60` (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary to avoid build-breaking caller mismatch. No scope creep.

## Issues Encountered

- **Pre-existing 03.5-05 commits:** Plans 03.5-05 was committed before 03.5-04 in a previous session (`3b2f33d`, `404c53b`, `087f431`). The `rootPassword` removal from schemas.ts was already committed by 03.5-05's `3b2f33d`, so Task 2's schema changes showed as already applied. No conflict — the edits were identical.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- **Ready:** All container call sites use DB-based auth. Plans 06 (settings UI), 07 (wizard updates), and 08 (dashboard updates) can proceed.
- **Note:** Client-side wizard components (`configure-step.tsx`, `container-wizard.tsx`) still reference `rootPassword` in form fields. These are stripped by Zod validation on the server but should be cleaned up in Plan 07 (wizard updates).

## Self-Check: PASSED

---
*Phase: 03.5-infrastructure-refactor*
*Completed: 2026-02-20*
