---
phase: 03.5-infrastructure-refactor
plan: 06
type: execute
wave: 4
depends_on: ["03.5-03"]
files_modified:
  - apps/dashboard/src/app/(dashboard)/settings/nodes/page.tsx
  - apps/dashboard/src/components/nodes/node-form-dialog.tsx
  - apps/dashboard/src/components/nodes/node-card.tsx
  - apps/dashboard/src/components/nodes/no-nodes-banner.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /settings/nodes and see their Proxmox nodes"
    - "User can add a new node with connection testing on save"
    - "User can edit and delete existing nodes"
    - "User can set a node as default"
    - "First node added automatically becomes the default"
  artifacts:
    - path: "apps/dashboard/src/app/(dashboard)/settings/nodes/page.tsx"
      provides: "Settings page for Proxmox node management"
      min_lines: 30
    - path: "apps/dashboard/src/components/nodes/node-form-dialog.tsx"
      provides: "Dialog form for creating and editing nodes"
      contains: "createNodeAction"
    - path: "apps/dashboard/src/components/nodes/node-card.tsx"
      provides: "Node display card with actions"
      contains: "ProxmoxNode"
  key_links:
    - from: "apps/dashboard/src/components/nodes/node-form-dialog.tsx"
      to: "apps/dashboard/src/lib/nodes/actions.ts"
      via: "useAction for CRUD operations"
      pattern: "useAction.*createNodeAction"
    - from: "apps/dashboard/src/app/(dashboard)/settings/nodes/page.tsx"
      to: "apps/dashboard/src/lib/db.ts"
      via: "DatabaseService for server-side data fetching"
      pattern: "getUserNodesWithContainerCount"
---

<objective>
Build the /settings/nodes page for Proxmox node management. Users can add, edit, delete, and set default nodes with connection testing on save.

Purpose: This is the user-facing interface for managing Proxmox connections — the replacement for env-var configuration. Per user decision: dedicated settings page, API token auth only, test connection on save, per-user nodes.
Output: Working settings page at /settings/nodes with full CRUD.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@.planning/phases/03.5-infrastructure-refactor/03.5-03-SUMMARY.md
@apps/dashboard/src/lib/nodes/actions.ts
@apps/dashboard/src/lib/nodes/schemas.ts
@apps/dashboard/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings page and node components</name>
  <files>
    apps/dashboard/src/app/(dashboard)/settings/nodes/page.tsx
    apps/dashboard/src/components/nodes/node-form-dialog.tsx
    apps/dashboard/src/components/nodes/node-card.tsx
    apps/dashboard/src/components/nodes/no-nodes-banner.tsx
  </files>
  <action>
**Page: `app/(dashboard)/settings/nodes/page.tsx`** (React Server Component):
- Import `getSessionData` from session.ts to get userId
- Fetch nodes: `DatabaseService.getUserNodesWithContainerCount(sessionData.username)`
- If no session, redirect to /login
- Render page header "Proxmox Nodes" with an "Add Node" button that opens NodeFormDialog
- List nodes as NodeCard components
- If no nodes, show NoNodesBanner

**Component: `components/nodes/node-form-dialog.tsx`** ("use client"):
- shadcn Dialog with Form (react-hook-form + zodResolver)
- `mode` prop: "create" | "edit" (like BucketFormDialog pattern)
- Form fields using shadcn components:
  - Name (Input) — display name for the node
  - Host (Input) — Proxmox hostname/IP
  - Port (Input, number, default 8006)
  - API Token ID (Input) — e.g., `root@pam!dashboard`
  - API Token Secret (Input, type="password") — the token secret value
  - SSH Password (Input, type="password", optional) — for pct exec access, label explains "Required for container monitoring and service logs"
- "Test Connection" button (optional, uses testNodeConnectionAction) — shows success/error inline
- Submit: calls `createNodeAction` or `updateNodeAction` via `useAction()`
- On success: toast, close dialog
- On error: toast with error message (connection test failure shows specific message)
- In edit mode: pre-fill fields, tokenSecret/sshPassword fields show placeholder "Leave empty to keep current"

**Component: `components/nodes/node-card.tsx`** ("use client"):
- shadcn Card displaying: name, host:port, token ID (masked), container count, isDefault badge
- Actions: Edit (opens NodeFormDialog in edit mode), Delete (with AlertDialog confirmation), Set as Default (if not already default)
- Delete uses `deleteNodeAction` via `useAction()` — shows toast on success/error
- Set Default uses `setDefaultNodeAction` — shows toast
- Show Badge variant="default" with "Default" text if isDefault is true

**Component: `components/nodes/no-nodes-banner.tsx`**:
- Reusable banner component for when no nodes are configured
- shadcn Alert with amber styling (variant="default", amber border/bg)
- AlertTriangle icon
- Title: "No Proxmox Nodes Configured"
- Description: "Add a Proxmox node to start managing containers." with a Link to /settings/nodes (or inline "Add Node" button if on settings page)
- This component will be reused on the dashboard and wizard pages

**Sidebar update:** The Settings nav item in app-sidebar.tsx already points to `/settings`. Update it to point to `/settings/nodes` since that's the only settings page. Or add a redirect from `/settings` to `/settings/nodes`.

Follow CLAUDE.md conventions:
- All shadcn components (Form, Input, Button, Dialog, Card, Badge, Alert, AlertDialog)
- useAction from next-safe-action/hooks
- Toast via sonner
- zodResolver for form validation
  </action>
  <verify>
1. Navigate to /settings/nodes — page loads without error
2. "Add Node" button opens a dialog with all required fields
3. Verify shadcn components used (no raw HTML form elements)
4. Delete button shows AlertDialog confirmation
5. No TypeScript compilation errors in the settings page files
  </verify>
  <done>
Settings page at /settings/nodes with node cards, add/edit dialog, delete confirmation, set default action, and no-nodes banner. All using shadcn components and established patterns.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify settings page functionality</name>
  <what-built>Proxmox node management settings page at /settings/nodes with full CRUD, connection testing, and default node management.</what-built>
  <how-to-verify>
1. Navigate to http://localhost:3001/settings/nodes
2. Verify "No Proxmox Nodes Configured" banner shows when empty
3. Click "Add Node" — form dialog opens with all fields
4. Fill in valid Proxmox credentials and click save
5. Verify connection test runs (may show error if Proxmox not reachable in dev)
6. Verify node appears as a card with "Default" badge (first node)
7. Click Edit on the node — verify form pre-fills
8. Try adding a second node — verify first keeps "Default" badge
9. Click "Set as Default" on second node — verify badge moves
10. Click Delete on a node — verify confirmation dialog appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. /settings/nodes page renders with correct layout
2. Node CRUD operations work via server actions
3. Connection testing validates before save
4. First node auto-becomes default
5. Delete requires confirmation
6. All shadcn components used per CLAUDE.md
</verification>

<success_criteria>
- Settings page accessible at /settings/nodes
- Full CRUD for Proxmox nodes
- Connection tested on save
- Default node management works
- No-nodes banner component ready for reuse
- Visual quality meets dashboard standards
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-06-SUMMARY.md`
</output>
