---
phase: 03.5-infrastructure-refactor
plan: 05
type: execute
wave: 3
depends_on: ["03.5-01", "03.5-02"]
files_modified:
  - apps/dashboard/src/workers/container-creation.ts
  - apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts
  - apps/dashboard/src/lib/queue/container-creation.ts
autonomous: true

must_haves:
  truths:
    - "Worker resolves Proxmox client from DB node record via nodeId in job data"
    - "Worker SSH connection uses node.host and node.sshPassword from DB"
    - "Service logs API route uses DB-stored node credentials for SSH"
    - "No references to PVE_HOST or PVE_ROOT_PASSWORD in worker or API routes"
  artifacts:
    - path: "apps/dashboard/src/workers/container-creation.ts"
      provides: "Worker with DB-based auth for both Proxmox API and SSH"
      contains: "createProxmoxClientFromNode"
    - path: "apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts"
      provides: "Service logs route with DB-based SSH auth"
      contains: "decrypt"
  key_links:
    - from: "apps/dashboard/src/workers/container-creation.ts"
      to: "apps/dashboard/src/lib/db.ts"
      via: "DatabaseService.getNodeById for credential resolution"
      pattern: "getNodeById"
    - from: "apps/dashboard/src/workers/container-creation.ts"
      to: "apps/dashboard/src/lib/proxmox/index.ts"
      via: "createProxmoxClientFromNode for API calls"
      pattern: "createProxmoxClientFromNode"
---

<objective>
Migrate the BullMQ worker and service logs API route from env-var-based authentication to DB-stored node credentials. The worker runs outside Next.js — it has no session, so it resolves credentials from nodeId in job data.

Purpose: Worker and API routes are the remaining env-var call sites. After this, PVE_HOST/PVE_ROOT_PASSWORD can be fully removed from the environment.
Output: Worker and service logs route use DB-based Proxmox and SSH credentials.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@.planning/phases/03.5-infrastructure-refactor/03.5-01-SUMMARY.md
@apps/dashboard/src/workers/container-creation.ts
@apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts
@apps/dashboard/src/lib/queue/container-creation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate worker from env-var to DB-based auth</name>
  <files>
    apps/dashboard/src/workers/container-creation.ts
    apps/dashboard/src/lib/queue/container-creation.ts
  </files>
  <action>
The worker has two types of env-var usage:
1. Proxmox API client (line ~231): `getProxmoxClient()` call
2. SSH connection (lines ~317-328): `process.env.PVE_HOST` and `process.env.PVE_ROOT_PASSWORD` for SSH into the Proxmox host

**Worker Proxmox client (line ~231):**
- The worker already receives `nodeId` in `ContainerJobData`
- Replace `getProxmoxClient()` with: load node from DB → `createProxmoxClientFromNode(node)`
- `const node = await DatabaseService.getNodeById(job.data.nodeId);`
- `if (!node) throw new Error("Node not found: " + job.data.nodeId);`
- `const client = createProxmoxClientFromNode(node);`

**Worker SSH connection (lines ~317-328):**
- Currently SSHs into the Proxmox host using `PVE_HOST` as hostname and `PVE_ROOT_PASSWORD` as password
- Replace with: `node.host` for hostname and `decrypt(node.sshPassword)` for password
- If `node.sshPassword` is null/undefined, throw error: "SSH password not configured for node {node.name}. Update node settings."
- The SSH username is likely "root" — check the current code for what username it uses and keep the same

**Worker rootPassword:**
- The worker likely passes `rootPassword` to Proxmox API when creating the container. Check if it does — the Proxmox API `createContainer` call uses `password` field. This is separate from DB storage — the Proxmox API still needs a password to set the container's root password.
- The password is still sent to Proxmox API (it sets the container's root password), but we no longer STORE it in our DB. The worker should still generate/receive a password for the Proxmox API call, it just doesn't persist it.
- Check `ContainerJobData` — if it includes `rootPassword`, keep it in the job data (it's needed for Proxmox API) but the value comes from the wizard form (user input or generated). We just don't call `DatabaseService.createContainer` with it.
- Actually, the user decision says "Drop password field from creation wizard." So the wizard no longer collects a password. The worker can generate a random password for the Proxmox API (Proxmox requires one for container creation), but we don't store or show it. Use a random 32-char password generated at worker time.

**ContainerJobData type (queue/container-creation.ts):**
- If `rootPassword` is in the job data type, remove it. The worker will generate its own random password.
- Add any missing fields if needed.

**Remove ALL `process.env.PVE_HOST`, `process.env.PVE_ROOT_PASSWORD`, `process.env.PVE_PORT` references from the worker file.**

Add imports: `createProxmoxClientFromNode` from proxmox, `DatabaseService` from db, `decrypt` from encryption.
  </action>
  <verify>
Run `grep -rn "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT" apps/dashboard/src/workers/` — should return 0 results.
Run `grep -rn "getProxmoxClient\b" apps/dashboard/src/workers/` — should return 0 results.
Read the worker file and confirm:
1. Node is loaded from DB via nodeId
2. Proxmox client created via createProxmoxClientFromNode
3. SSH uses node.host + decrypt(node.sshPassword)
4. Random password generated for Proxmox API (not stored in DB)
  </verify>
  <done>
Worker uses DB-based credentials for both Proxmox API and SSH. No env-var references. Random password generated for Proxmox container creation (not stored).
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate service logs API route from env-var to DB-based auth</name>
  <files>
    apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts
  </files>
  <action>
The service logs route SSHs into the Proxmox host to run `pct exec` for fetching service logs. It currently uses `PVE_HOST` and `PVE_ROOT_PASSWORD` env vars.

**Refactor:**
1. Load the container from DB: `DatabaseService.getContainerById(containerId)` — this already includes the `node` relation
2. Use `container.node.host` for SSH hostname
3. Use `decrypt(container.node.sshPassword)` for SSH password
4. If `node.sshPassword` is null, return an error response: "SSH not configured for this node"
5. Remove ALL `process.env.PVE_HOST`, `process.env.PVE_ROOT_PASSWORD` references

**Auth check:** This route should also verify the user is authenticated. Add session check: call `getSessionData()` from session.ts. If no session, return 401. Note: this is an API route, not a server action, so authActionClient doesn't apply. Manual session check is needed.

Import `DatabaseService` from `@/lib/db`, `decrypt` from `@/lib/encryption`, `getSessionData` from `@/lib/session`.

Keep the rest of the route logic (SSH connection, command execution, response) the same — just change credential source.
  </action>
  <verify>
Run `grep -rn "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT" apps/dashboard/src/app/api/` — should return 0 results.
Read the file and confirm:
1. Container loaded from DB with node relation
2. SSH credentials come from node record
3. Session check present for auth
4. No env-var references
  </verify>
  <done>
Service logs route uses DB-stored node credentials for SSH. Session check added for auth. No env-var references remain in API routes.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "PVE_HOST\|PVE_ROOT_PASSWORD\|PVE_PORT" apps/dashboard/src/workers/ apps/dashboard/src/app/api/` — 0 results
2. Worker resolves all credentials from DB
3. Service logs route resolves all credentials from DB
4. Worker generates random password for Proxmox API (not stored)
5. Both files import from db.ts and encryption.ts
</verification>

<success_criteria>
- Worker uses DB-based auth for Proxmox API and SSH
- Service logs route uses DB-based auth for SSH
- No env-var references in worker or API routes
- Worker handles missing sshPassword gracefully
- ContainerJobData no longer requires rootPassword
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-05-SUMMARY.md`
</output>
