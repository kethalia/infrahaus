---
phase: 03.5-infrastructure-refactor
plan: 05
subsystem: infra
tags: [bullmq, worker, ssh, proxmox, db-auth, encryption]

# Dependency graph
requires:
  - phase: 03.5-infrastructure-refactor
    provides: Schema with sshPassword on ProxmoxNode, userId-scoped queries (plan 01), createProxmoxClientFromNode factory (plan 04)
provides:
  - Worker uses DB-based auth for both Proxmox API and SSH
  - Service logs route uses DB-based SSH auth with session check
  - rootPassword removed from ContainerJobData and container schemas
  - No PVE_HOST/PVE_ROOT_PASSWORD references in worker or API routes
affects:
  - 03.5-07 (wizard updates — password field already removed from schemas here)
  - 03.5-08 (dashboard updates may reference worker changes)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Worker resolves credentials from DB via nodeId in job data (no session needed)"
    - "Random password generation for Proxmox API container creation (not stored)"
    - "Session check in API routes via getSessionData() for auth"

key-files:
  created: []
  modified:
    - "apps/dashboard/src/workers/container-creation.ts"
    - "apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts"
    - "apps/dashboard/src/lib/queue/container-creation.ts"
    - "apps/dashboard/src/lib/containers/actions.ts"
    - "apps/dashboard/src/lib/containers/schemas.ts"

key-decisions:
  - "Worker generates random 32-char hex password for Proxmox API — not stored anywhere, container accessed via pct exec"
  - "rootPassword removed from ContainerJobData type and container config schemas in this plan (not deferred to 03.5-07)"
  - "Service logs route gets session check via getSessionData() — returns 401 if unauthenticated"

patterns-established:
  - "Worker credential resolution: DatabaseService.getNodeById(nodeId) → createProxmoxClientFromNode(node) for API, decrypt(node.sshPassword) for SSH"
  - "API route SSH auth: container.node.host + decrypt(container.node.sshPassword)"

# Metrics
duration: 3min
completed: 2026-02-20
---

# Phase 3.5 Plan 05: Worker + Service Logs Route Migration Summary

**BullMQ worker and service logs API route migrated from env-var auth to DB-stored node credentials for both Proxmox API and SSH connections**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-20T20:38:11Z
- **Completed:** 2026-02-20T20:41:19Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Worker resolves Proxmox client from DB node record via `createProxmoxClientFromNode(node)` instead of `getProxmoxClient()` env-var factory
- Worker SSH connection uses `node.host` and `decrypt(node.sshPassword)` from DB instead of `PVE_HOST`/`PVE_ROOT_PASSWORD` env vars
- Worker generates random 32-char hex password for Proxmox API container creation (not stored in DB or shown to user)
- Service logs API route uses `container.node` relation for SSH credentials, with session auth check
- `rootPassword` fully removed from `ContainerJobData` type, container schemas, and enqueue call
- Zero references to `PVE_HOST`, `PVE_ROOT_PASSWORD`, or `PVE_PORT` remain in workers/ or app/api/

## Task Commits

Each task was committed atomically:

1. **Task 1: Migrate worker from env-var to DB-based auth** - `3b2f33d` (feat)
2. **Task 2: Migrate service logs API route from env-var to DB-based auth** - `404c53b` (feat)

## Files Created/Modified
- `apps/dashboard/src/workers/container-creation.ts` - Worker uses DB-based Proxmox client and SSH auth, generates random container password
- `apps/dashboard/src/app/api/containers/[id]/services/logs/route.ts` - Service logs route uses DB-based SSH auth with session check
- `apps/dashboard/src/lib/queue/container-creation.ts` - Removed rootPassword from ContainerJobData config type
- `apps/dashboard/src/lib/containers/actions.ts` - Removed rootPassword from enqueue call, updated comment
- `apps/dashboard/src/lib/containers/schemas.ts` - Removed rootPassword and confirmPassword from config schemas

## Decisions Made
- **Random password for Proxmox API:** Worker generates `crypto.randomBytes(16).toString("hex")` (32 chars) for the Proxmox API's password parameter when creating containers. This password is not stored anywhere — containers are accessed via `pct exec` through the Proxmox host, not via SSH into the container.
- **rootPassword removed in this plan:** The container config schemas (`containerConfigBaseSchema`, `createContainerInputSchema`) had rootPassword/confirmPassword removed here rather than deferring to plan 03.5-07. This keeps the pipeline coherent — removing from the type without removing from the schema would cause type errors.
- **Session check added to service logs route:** The route now calls `getSessionData()` and returns 401 if no valid session exists. This was missing — the route previously had no auth check (Rule 2: missing critical security check).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Removed rootPassword from container schemas**
- **Found during:** Task 1 (worker migration)
- **Issue:** Removing rootPassword from `ContainerJobData` and the enqueue call required also removing it from `createContainerInputSchema` and `containerConfigBaseSchema` to avoid type errors. The schema file had already been modified in the working tree (likely from a prior session).
- **Fix:** Included the schema changes in Task 1's commit since they're part of the rootPassword removal pipeline
- **Files modified:** `apps/dashboard/src/lib/containers/schemas.ts`
- **Verification:** No TypeScript type errors between schema → action → queue type → worker
- **Committed in:** 3b2f33d

---

**Total deviations:** 1 auto-fixed (1 missing critical — schema consistency)
**Impact on plan:** Necessary for type-safe rootPassword removal across the pipeline. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Worker and API routes fully migrated to DB-based auth
- Ready for 03.5-06-PLAN.md (Settings page UI for /settings/nodes)
- Wizard password fields already removed from schemas — plan 03.5-07 will focus on UI updates (node selector, VMID validation)
- Remaining env-var references exist in `lib/proxmox/index.ts` (getProxmoxClient function) and `lib/containers/actions.ts` (call sites) — these are being addressed by plan 03.5-04

## Self-Check: PASSED

---
*Phase: 03.5-infrastructure-refactor*
*Completed: 2026-02-20*
