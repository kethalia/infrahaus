# Phase 3.5: Infrastructure Refactor - Context

**Gathered:** 2026-02-20
**Status:** Ready for planning

<domain>
## Phase Boundary

Remove stored container passwords, cache VMIDs from Proxmox via Redis, and replace env-var auth with multi-user DB-stored credentials. Refactor monitoring from direct SSH to pct exec via Proxmox host. Add a settings page for per-user Proxmox node management.

</domain>

<decisions>
## Implementation Decisions

### Settings page for Proxmox nodes
- Dedicated `/settings/nodes` page — Proxmox node management only, no other app settings
- API token auth only (tokenId + tokenSecret) — no password-based auth. ProxmoxNode model already has these fields
- Test connection on save — hit Proxmox API with provided credentials before persisting, reject with error if unreachable
- Nodes are per-user — each authenticated user has their own set of nodes, no cross-user access
- Any authenticated user can access settings (no role system needed — home lab tool)

### Multi-node behavior
- Default node + optional override in creation wizard — wizard uses default, shows "Change node" option
- First node added becomes the default automatically — no extra setup step for single-node users
- Graceful degradation when no nodes configured — templates and non-node features still work, container operations (create, lifecycle, monitoring) disabled with clear messaging
- Container dashboard shows all containers from all nodes, filterable by node — node badge on each container card

### VMID picker in wizard
- Manual VMID entry only — empty field, user types a VMID
- Inline validation against cached taken IDs — red error if taken, green check if available. No visual map or range hints
- Proxmox default range accepted (100–999999999) — no artificial limits, don't be smarter than Proxmox
- On-demand cache refresh on wizard open + event-driven invalidation on container create/delete

### Migration path
- Drop `rootPassword` column entirely — clean break, Prisma migration removes the column
- Hard cutover for `getProxmoxClient()` — rewrite to read from DB only, remove all PVE_HOST/PVE_PORT/PVE_ROOT_PASSWORD env var references
- Dashboard with prominent banner when no nodes configured — consistent with graceful degradation decision
- No migration helper — this is a new app with no existing users, manual setup in settings

### Claude's Discretion
- pct exec session implementation details (SSH to Proxmox host vs API approach)
- Redis VMID cache structure and TTL strategy
- Credential encryption approach for DB-stored tokens
- Settings page layout, form design, and component structure
- Node connection test timeout and error messaging
- Banner component design for unconfigured state

</decisions>

<specifics>
## Specific Ideas

- Nodes are user-scoped — the mental model is "my nodes, my containers"
- API tokens over passwords — this is the direction, not a compromise
- Container cards should show which node they're on when filtering is available

</specifics>

<deferred>
## Deferred Ideas

- Universal Profile (LUKSO) + RainbowKit + SIWE auth system — full replacement of current SSO auth with Web3 wallet-based authentication. Per-profile encrypted credential storage. This is a complete auth overhaul, not an infrastructure refactor — its own phase.
- Admin role / RBAC system — no need for home lab, revisit if multi-user access control becomes a requirement
- Settings page expansion (app config, user preferences, notifications) — add sections as future phases need them

</deferred>

---

*Phase: 03.5-infrastructure-refactor*
*Context gathered: 2026-02-20*
