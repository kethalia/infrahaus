---
phase: 03.5-infrastructure-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/prisma/schema.prisma
  - apps/dashboard/src/lib/db.ts
  - apps/dashboard/src/generated/prisma/client
autonomous: true

must_haves:
  truths:
    - "ProxmoxNode model has userId, isDefault, and sshPassword fields"
    - "Container model no longer has rootPassword column"
    - "ProxmoxNode unique constraint is per-user (userId + name) not global"
    - "DatabaseService has userId-scoped node query methods"
    - "DatabaseService.createContainer no longer requires rootPassword"
  artifacts:
    - path: "apps/dashboard/prisma/schema.prisma"
      provides: "Updated ProxmoxNode and Container models"
      contains: "userId"
    - path: "apps/dashboard/src/lib/db.ts"
      provides: "User-scoped node queries and updated container creation"
      contains: "listNodesForUser"
  key_links:
    - from: "apps/dashboard/src/lib/db.ts"
      to: "apps/dashboard/prisma/schema.prisma"
      via: "Prisma client generated from schema"
      pattern: "prisma\\.proxmoxNode\\.(findMany|findFirst|create)"
---

<objective>
Migrate the Prisma schema to support multi-user node ownership and remove stored container passwords, then update DatabaseService with userId-scoped node queries.

Purpose: This is the foundation for the entire phase — every other plan depends on the schema having userId on ProxmoxNode and rootPassword removed from Container.
Output: Updated Prisma schema with migration applied, regenerated Prisma client, and updated DatabaseService methods.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@apps/dashboard/prisma/schema.prisma
@apps/dashboard/src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema migration — ProxmoxNode and Container models</name>
  <files>
    apps/dashboard/prisma/schema.prisma
  </files>
  <action>
Update the Prisma schema with these changes:

**ProxmoxNode model:**
- Add `userId String` field (required, no default — every node belongs to a user)
- Add `isDefault Boolean @default(false)` field
- Add `sshPassword String?` field (encrypted — for SSH to Proxmox host for pct exec)
- Change unique constraint from `name String @unique` to `@@unique([userId, name])` (compound unique — each user can have unique names within their own set)
- Add `@@index([userId])` for query performance

**Container model:**
- Remove `rootPassword String` line entirely — clean break per user decision
- Keep all other fields as-is

**Important:** The existing `getOrCreateNode()` helper in `actions.ts` creates nodes with placeholder data (`encrypt("env-auth-no-token")`). The decision says "no existing users, no migration helper" — this is a clean break. However, to handle any existing test data gracefully, the migration should:
1. Drop the `rootPassword` column from Container (Prisma will handle this)
2. Add nullable `userId` first, then make it required (or use a default placeholder, then alter)

Actually, since the user decision says "no existing users, manual setup in settings, no migration helper" — use `prisma db push` instead of `prisma migrate dev` to force-sync the schema. This avoids migration complexity for a dev-only database. If existing containers exist they'll need to be recreated anyway since node credentials will change.

Run `npx prisma db push --force-reset` to apply schema changes (this resets the dev database, which is acceptable per "no existing users" decision). Then run `npx prisma generate` to regenerate the Prisma client.

If `db push --force-reset` is too destructive and there's data worth keeping, use `prisma migrate dev --name infra-refactor` instead and handle the migration SQL manually — add userId as nullable first, then alter to required.
  </action>
  <verify>
Run `npx prisma validate` to confirm schema is valid. Run `npx prisma generate` and verify no errors. Check that `src/generated/prisma/client/index.d.ts` contains `userId` on ProxmoxNode and does NOT contain `rootPassword` on Container.
  </verify>
  <done>
ProxmoxNode has userId, isDefault, sshPassword fields with @@unique([userId, name]) constraint. Container model has no rootPassword field. Prisma client is regenerated and reflects both changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DatabaseService node methods for userId scoping</name>
  <files>
    apps/dashboard/src/lib/db.ts
  </files>
  <action>
Refactor the existing node methods in DatabaseService and add new ones:

**Replace existing methods:**

1. `getNodeByName(name)` → `getNodeByName(userId: string, name: string)` — add `where: { userId_name: { userId, name } }` using the compound unique
2. `listNodes()` → `listNodesForUser(userId: string)` — add `where: { userId }`, keep `orderBy: { createdAt: 'asc' }`
3. `createNode(data)` → update signature to include `userId: string`, `isDefault?: boolean`, `sshPassword?: string` in the data parameter
4. `updateNode(id, data)` → add `sshPassword: string | null` to the partial data type
5. `deleteNode(id)` → keep as-is (caller verifies ownership)

**Add new methods:**

6. `getDefaultNodeForUser(userId: string): Promise<ProxmoxNode | null>` — `findFirst({ where: { userId, isDefault: true } })`
7. `getUserNodesWithContainerCount(userId: string)` — `findMany({ where: { userId }, include: { _count: { select: { containers: true } } }, orderBy: { createdAt: 'asc' } })` — for the settings page to show how many containers each node has
8. `setDefaultNode(userId: string, nodeId: string)` — in a transaction: unset all user's nodes `isDefault: false`, then set the target node `isDefault: true`

**Update createContainer:**

9. Remove `rootPassword` from the `createContainer` data parameter. The signature should be:
```typescript
static async createContainer(data: {
  vmid: number;
  hostname?: string;
  nodeId: string;
  templateId?: string;
}): Promise<Container>
```

Keep `getNodeById(id)` as-is — it doesn't need userId scoping since it's used by the worker which receives nodeId directly.

**Type exports:** If there are any exported types that reference `rootPassword`, update them too. Check for `ContainerWithRelations` or similar type aliases.
  </action>
  <verify>
Run `npx tsc --noEmit` from `apps/dashboard/` to check for type errors. There WILL be errors in files that still reference `rootPassword` or `getProxmoxClient()` — that's expected and will be fixed in later plans. The goal is that db.ts itself compiles cleanly.

Verify by reading the file that:
- `listNodesForUser` accepts userId parameter
- `getDefaultNodeForUser` exists
- `createContainer` no longer has rootPassword in its signature
  </verify>
  <done>
DatabaseService has userId-scoped node methods (listNodesForUser, getDefaultNodeForUser, getUserNodesWithContainerCount, setDefaultNode). createContainer no longer requires rootPassword. getNodeById remains unchanged for worker use.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx prisma generate` succeeds
3. ProxmoxNode in generated client has: userId, isDefault, sshPassword
4. Container in generated client does NOT have: rootPassword
5. DatabaseService compiles with new method signatures
</verification>

<success_criteria>
- Schema reflects multi-user node ownership (userId + isDefault + sshPassword on ProxmoxNode)
- rootPassword completely removed from Container model and DatabaseService
- User-scoped query methods exist and are properly typed
- Prisma client regenerated successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-01-SUMMARY.md`
</output>
