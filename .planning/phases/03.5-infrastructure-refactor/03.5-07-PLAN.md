---
phase: 03.5-infrastructure-refactor
plan: 07
type: execute
wave: 4
depends_on: ["03.5-03", "03.5-04"]
files_modified:
  - apps/dashboard/src/app/(dashboard)/containers/create/page.tsx
  - apps/dashboard/src/components/containers/creation-wizard.tsx
  - apps/dashboard/src/components/containers/wizard-steps/configure-step.tsx
  - apps/dashboard/src/components/containers/vmid-field.tsx
autonomous: true

must_haves:
  truths:
    - "Wizard no longer shows password/confirm password fields"
    - "Wizard has manual VMID entry with inline validation against cached IDs"
    - "Wizard shows default node with option to change"
    - "VMID validation shows red error if taken and green check if available"
    - "Wizard shows graceful message when no nodes configured"
  artifacts:
    - path: "apps/dashboard/src/components/containers/vmid-field.tsx"
      provides: "VMID input with inline cache validation"
      contains: "isVmidTaken"
    - path: "apps/dashboard/src/components/containers/creation-wizard.tsx"
      provides: "Updated wizard without password fields, with node selector"
      min_lines: 50
  key_links:
    - from: "apps/dashboard/src/components/containers/vmid-field.tsx"
      to: "apps/dashboard/src/lib/vmid-cache.ts"
      via: "Server action for VMID validation"
      pattern: "isVmidTaken|checkVmidAction"
    - from: "apps/dashboard/src/components/containers/creation-wizard.tsx"
      to: "apps/dashboard/src/lib/containers/actions.ts"
      via: "createContainerAction (no rootPassword)"
      pattern: "createContainerAction"
---

<objective>
Update the container creation wizard to remove password fields, add VMID inline validation against the Redis cache, and add a node selector (default node with "Change node" option). Show graceful degradation when no nodes configured.

Purpose: Per user decisions — drop password field, manual VMID entry with inline validation, default node + optional override, graceful degradation.
Output: Updated wizard that works with the new DB-based auth and VMID cache.
</objective>

<execution_context>
@/home/coder/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/coder/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.5-infrastructure-refactor/03.5-RESEARCH.md
@.planning/phases/03.5-infrastructure-refactor/03.5-03-SUMMARY.md
@.planning/phases/03.5-infrastructure-refactor/03.5-04-SUMMARY.md
@apps/dashboard/src/components/containers/creation-wizard.tsx
@apps/dashboard/src/lib/containers/schemas.ts
@apps/dashboard/src/lib/vmid-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VMID validation field component and check action</name>
  <files>
    apps/dashboard/src/components/containers/vmid-field.tsx
    apps/dashboard/src/lib/containers/actions.ts
  </files>
  <action>
**New server action in containers/actions.ts:**

Add a `checkVmidAction` that checks if a VMID is taken:
```typescript
export const checkVmidAction = authActionClient
  .schema(z.object({ nodeId: z.string(), vmid: z.coerce.number().int().min(100) }))
  .action(async ({ parsedInput: { nodeId, vmid } }) => {
    const taken = await isVmidTaken(nodeId, vmid);
    return { taken };
  });
```

Import `isVmidTaken` from `@/lib/vmid-cache`.

Also add a `refreshVmidCacheAction` that refreshes the cache for a node:
```typescript
export const refreshVmidCacheAction = authActionClient
  .schema(z.object({ nodeId: z.string() }))
  .action(async ({ parsedInput: { nodeId }, ctx }) => {
    const node = await DatabaseService.getNodeById(nodeId);
    if (!node) throw new ActionError("Node not found");
    const client = createProxmoxClientFromNode(node);
    const vmids = await refreshVmidCache(nodeId, node.name, client);
    return { count: vmids.length };
  });
```

**New component: `components/containers/vmid-field.tsx`** ("use client"):

A smart VMID input field with inline validation:
- Input field for VMID number (shadcn Input, type="number")
- On blur or after a short debounce (~500ms), calls `checkVmidAction` with the current nodeId and entered VMID
- Displays inline status:
  - Loading: small spinner next to field
  - Available: green check icon + "VMID available" text (text-green-600)
  - Taken: red X icon + "VMID already in use" text (text-destructive) — also sets form error
  - Empty/invalid: no indicator
- Accepts Proxmox default range (100–999999999) per user decision — no artificial limits
- Props: `nodeId: string`, `control` from react-hook-form (for FormField integration), `name: string`
- Use `useAction` for the check call, handle isPending state
- Component integrates into the wizard's Form via FormField pattern

**Important:** The VMID field should work within the existing react-hook-form context. Use `useFormContext()` or accept the form control as a prop.
  </action>
  <verify>
1. vmid-field.tsx exists and is a "use client" component
2. checkVmidAction exists in containers/actions.ts
3. refreshVmidCacheAction exists in containers/actions.ts
4. Component uses debounced validation with visual feedback
5. Proxmox range 100-999999999 accepted
  </verify>
  <done>
VMID field component with inline validation against Redis cache. Shows green check for available, red error for taken. Server actions for checking and refreshing cache.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wizard to remove password, add node selector, integrate VMID field</name>
  <files>
    apps/dashboard/src/app/(dashboard)/containers/create/page.tsx
    apps/dashboard/src/components/containers/creation-wizard.tsx
    apps/dashboard/src/components/containers/wizard-steps/configure-step.tsx
  </files>
  <action>
**Wizard page (create/page.tsx):**
- This RSC page calls `getWizardData()`. After Plan 04's migration, `getWizardData()` accepts a `nodeId` parameter.
- Get user's default node: `getSessionData()` → `DatabaseService.getDefaultNodeForUser(sessionData.username)`
- If no default node → render the NoNodesBanner component (from Plan 06) instead of the wizard
- If default node exists → call `getWizardData(defaultNode.id)` and pass data + nodeId + userNodes list to wizard
- Also fetch `DatabaseService.listNodesForUser(sessionData.username)` for the node selector
- Refresh VMID cache on page load: import `createProxmoxClientFromNode` from `@/lib/proxmox`, create the client via `const client = createProxmoxClientFromNode(defaultNode)`, then call `refreshVmidCache(defaultNode.id, defaultNode.name, client)` server-side

**Creation wizard component updates:**
- Remove password/confirmPassword fields entirely from the form
- Remove password-related validation (manual confirm check in onSubmit, etc.)
- Add `nodeId` to the form state (hidden field, defaults to default node, changeable via selector)
- Add node selector: show current node name with a "Change node" dropdown/select (shadcn Select) listing all user's nodes. When changed, refresh wizard data for the new node (this may require a page reload or client-side fetch).
- Integrate VmidField component in place of whatever VMID input exists currently
- The form submission data now includes `nodeId` (which node to create on) and does NOT include `rootPassword`

**Configure step updates:**
- Remove password and confirm password FormFields
- Add VmidField component where the VMID input was (or next to existing VMID field)
- VMID is now a manual entry field (user types it) — not auto-suggested from Proxmox API
- Keep all other fields (hostname, template selection, resources, etc.)

**Schema alignment:** Ensure the form's Zod schema matches the updated `containerConfigSchema` from containers/schemas.ts (no rootPassword, has nodeId).
  </action>
  <verify>
1. Navigate to /containers/create — wizard loads
2. No password/confirmPassword fields visible
3. VMID is a text/number input (not dropdown or auto-filled)
4. Node selector shows default node with option to change
5. If no nodes configured, banner shows instead of wizard
6. Form submission includes nodeId, does not include rootPassword
  </verify>
  <done>
Wizard updated: no password fields, manual VMID entry with inline validation, default node with change option, graceful degradation when no nodes configured.
  </done>
</task>

</tasks>

<verification>
1. Wizard page shows NoNodesBanner when no nodes configured
2. Wizard shows node selector with default node pre-selected
3. No password fields in the wizard
4. VMID field validates against cache with visual feedback
5. Form submits nodeId to createContainerAction
6. Schema matches between client and server
</verification>

<success_criteria>
- Password fields fully removed from wizard UI and form data
- VMID inline validation works (green check/red error)
- Node selector shows default with change option
- Graceful degradation when no nodes configured
- Wizard form submits successfully to updated createContainerAction
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-infrastructure-refactor/03.5-07-SUMMARY.md`
</output>
