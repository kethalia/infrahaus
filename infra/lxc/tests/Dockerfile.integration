FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV container=docker

# Install systemd and test dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        systemd \
        systemd-sysv \
        dbus \
        bash \
        git \
        curl \
        ca-certificates \
        sudo \
        shellcheck \
        coreutils \
        findutils \
    && rm -rf /var/lib/apt/lists/*

# Install BATS
RUN git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core && \
    /tmp/bats-core/install.sh /usr/local && \
    rm -rf /tmp/bats-core

RUN git clone --depth 1 https://github.com/bats-core/bats-support.git /usr/local/lib/bats-support && \
    git clone --depth 1 https://github.com/bats-core/bats-assert.git /usr/local/lib/bats-assert

# Create directory structure
RUN mkdir -p /etc/config-manager \
             /var/log/config-manager \
             /var/lib/config-manager/{backups,state} \
             /opt/config-manager/repo \
             /usr/local/lib/config-manager/package-handlers \
             /run/config-manager \
             /etc/sudoers.d

# Clean up systemd units that don't work in Docker
RUN cd /lib/systemd/system/sysinit.target.wants/ && \
    ls | grep -v systemd-tmpfiles-setup | xargs rm -f -- 2>/dev/null || true; \
    rm -f /lib/systemd/system/multi-user.target.wants/*; \
    rm -f /etc/systemd/system/*.wants/*; \
    rm -f /lib/systemd/system/local-fs.target.wants/*; \
    rm -f /lib/systemd/system/sockets.target.wants/*udev*; \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \
    rm -f /lib/systemd/system/basic.target.wants/*; \
    rm -f /lib/systemd/system/anaconda.target.wants/* 2>/dev/null || true

VOLUME ["/sys/fs/cgroup"]

WORKDIR /workspace

# Copy source code into the image (build context is project root)
COPY . /workspace/

# Use systemd as init
STOPSIGNAL SIGRTMIN+3
CMD ["/sbin/init"]
