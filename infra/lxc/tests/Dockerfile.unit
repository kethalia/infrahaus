FROM debian:12-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install test dependencies
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
        bash \
        git \
        curl \
        ca-certificates \
        shellcheck \
        sudo \
        coreutils \
        findutils \
        cmake \
        make \
        g++ \
        pkg-config \
        libdw-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libelf-dev \
        binutils-dev \
        libiberty-dev \
        zlib1g-dev \
        python3 \
    && rm -rf /var/lib/apt/lists/*

# Install kcov for code coverage
RUN git clone --depth 1 --branch v43 https://github.com/SimonKagstrom/kcov.git /tmp/kcov && \
    mkdir -p /tmp/kcov/build && \
    cd /tmp/kcov/build && \
    cmake .. && \
    make && \
    make install && \
    rm -rf /tmp/kcov

# Install BATS
RUN git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core && \
    /tmp/bats-core/install.sh /usr/local && \
    rm -rf /tmp/bats-core

# Install BATS helper libraries
RUN git clone --depth 1 https://github.com/bats-core/bats-support.git /usr/local/lib/bats-support && \
    git clone --depth 1 https://github.com/bats-core/bats-assert.git /usr/local/lib/bats-assert

# Create directory structure that config-manager expects
RUN mkdir -p /etc/config-manager \
             /var/log/config-manager \
             /var/lib/config-manager/{backups,state} \
             /opt/config-manager/repo \
             /usr/local/lib/config-manager/package-handlers \
             /run/config-manager

WORKDIR /workspace

# Copy source code into the image (build context is project root)
COPY . /workspace/
