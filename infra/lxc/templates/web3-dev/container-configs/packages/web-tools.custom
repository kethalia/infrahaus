#!/bin/bash
# Custom installer for browser-based development tools
# - code-server: VS Code in the browser
# - filebrowser: Web-based file manager
# - opencode: Alternative code editor with webui

set -euo pipefail

INSTALL_LOG="/var/log/web-tools-install.log"
exec > >(tee -a "$INSTALL_LOG") 2>&1

echo "=== Installing browser-based development tools ==="

# Install code-server (VS Code in browser)
install_code_server() {
    echo "Installing code-server..."
    
    # Install code-server
    curl -fsSL https://code-server.dev/install.sh | sh -s -- --version 4.20.0
    
    # Create systemd service for coder user
    cat > /etc/systemd/system/code-server@.service <<'EOF'
[Unit]
Description=code-server
After=network.target

[Service]
Type=exec
ExecStart=/usr/bin/code-server --bind-addr 0.0.0.0:8080 --auth password
Restart=always
User=%i
Environment=PASSWORD=coder

[Install]
WantedBy=default.target
EOF

    systemctl daemon-reload
    systemctl enable code-server@coder
    systemctl start code-server@coder
    
    echo "✓ code-server installed and running on port 8080 (password: coder)"
}

# Install filebrowser
install_filebrowser() {
    echo "Installing filebrowser..."
    
    # Download and install filebrowser
    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash
    
    # Create filebrowser config
    mkdir -p /etc/filebrowser
    cat > /etc/filebrowser/config.json <<'EOF'
{
  "port": 8081,
  "baseURL": "",
  "address": "0.0.0.0",
  "log": "stdout",
  "database": "/etc/filebrowser/filebrowser.db",
  "root": "/home/coder"
}
EOF

    # Create systemd service
    cat > /etc/systemd/system/filebrowser.service <<'EOF'
[Unit]
Description=File Browser
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/filebrowser -c /etc/filebrowser/config.json
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

    # Initialize database and set admin user
    filebrowser -d /etc/filebrowser/filebrowser.db config init
    filebrowser -d /etc/filebrowser/filebrowser.db users add admin coder --perm.admin
    
    systemctl daemon-reload
    systemctl enable filebrowser
    systemctl start filebrowser
    
    echo "✓ filebrowser installed and running on port 8081 (admin/coder)"
}

# Install opencode
install_opencode() {
    echo "Installing opencode..."
    
    # Install opencode via npm
    npm install -g @opencoder/opencode
    
    # Create systemd service for opencode
    cat > /etc/systemd/system/opencode@.service <<'EOF'
[Unit]
Description=OpenCode Web Editor
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/opencode --host 0.0.0.0 --port 8082
Restart=always
User=%i
WorkingDirectory=/home/%i

[Install]
WantedBy=default.target
EOF

    systemctl daemon-reload
    systemctl enable opencode@coder
    systemctl start opencode@coder
    
    echo "✓ opencode installed and running on port 8082"
}

# Install VS Code extensions for code-server
install_vscode_extensions() {
    echo "Installing VS Code extensions for code-server..."
    
    # Wait for code-server to be fully started
    sleep 5
    
    # Install extensions as coder user
    sudo -u coder /usr/bin/code-server --install-extension dbaeumer.vscode-eslint
    sudo -u coder /usr/bin/code-server --install-extension esbenp.prettier-vscode
    sudo -u coder /usr/bin/code-server --install-extension ms-vscode.vscode-typescript-next
    sudo -u coder /usr/bin/code-server --install-extension GitHub.copilot
    sudo -u coder /usr/bin/code-server --install-extension eamodio.gitlens
    sudo -u coder /usr/bin/code-server --install-extension ms-azuretools.vscode-docker
    sudo -u coder /usr/bin/code-server --install-extension JuanBlanco.solidity
    sudo -u coder /usr/bin/code-server --install-extension NomicFoundation.hardhat-solidity
    
    echo "✓ VS Code extensions installed"
}

# Configure VS Code settings
configure_vscode_settings() {
    echo "Configuring VS Code settings..."
    
    mkdir -p /home/coder/.local/share/code-server/User
    cat > /home/coder/.local/share/code-server/User/settings.json <<'EOF'
{
    "workbench.colorTheme": "Default Dark+",
    "editor.fontSize": 14,
    "editor.tabSize": 2,
    "editor.formatOnSave": true,
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "files.autoSave": "afterDelay",
    "files.autoSaveDelay": 1000,
    "terminal.integrated.fontSize": 14,
    "git.enableSmartCommit": true,
    "git.confirmSync": false,
    "prettier.semi": false,
    "prettier.singleQuote": true,
    "prettier.trailingComma": "es5",
    "[javascript]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
    "[typescript]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
    "[json]": {
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
    "[solidity]": {
        "editor.defaultFormatter": "JuanBlanco.solidity"
    }
}
EOF

    chown -R coder:coder /home/coder/.local/share/code-server
    
    echo "✓ VS Code settings configured"
}

# Main installation
main() {
    install_code_server
    install_filebrowser
    # install_opencode  # Commented out - opencode package may not exist
    install_vscode_extensions
    configure_vscode_settings
    
    echo ""
    echo "=== Web Tools Installation Complete ==="
    echo ""
    echo "Access URLs (replace <container-ip> with your container's IP):"
    echo "  - VS Code:      http://<container-ip>:8080  (password: coder)"
    echo "  - FileBrowser:  http://<container-ip>:8081  (admin/coder)"
    echo "  - OpenCode:     http://<container-ip>:8082"
    echo ""
    echo "All services are running and will start automatically on boot."
}

main
