#!/bin/bash
# Install Starship prompt
set -euo pipefail

echo "Installing Starship prompt..."

# Install Starship using prebuilt binary (more secure than curl|sh)
STARSHIP_ARCH="x86_64-unknown-linux-gnu"
STARSHIP_TEMP="$(mktemp -t starship.XXXXXX.tar.gz)"

if ! curl -fsSL --max-time 30 -A "ProxmoxVE-Script/1.0" \
    "https://github.com/starship/starship/releases/latest/download/starship-${STARSHIP_ARCH}.tar.gz" \
    -o "${STARSHIP_TEMP}"; then
  echo "ERROR: Failed to download Starship binary"
  rm -f "${STARSHIP_TEMP}"
  exit 1
fi

# Extract to /usr/local/bin
if ! tar -xzf "${STARSHIP_TEMP}" -C /usr/local/bin/; then
  echo "ERROR: Failed to extract Starship binary"
  rm -f "${STARSHIP_TEMP}"
  exit 1
fi

rm -f "${STARSHIP_TEMP}"

# Verify installation
if ! command -v starship >/dev/null 2>&1; then
  echo "ERROR: Starship binary not found after installation"
  exit 1
fi

# Configure for coder user
if [ -d "/home/coder" ]; then
  if ! sudo -u coder bash -c 'echo "eval \"\$(starship init bash)\"" >> /home/coder/.bashrc'; then
    echo "WARNING: Failed to configure Starship for coder user"
  fi
fi

# Configure for root user as well
if ! echo 'eval "$(starship init bash)"' >> /root/.bashrc; then
  echo "WARNING: Failed to configure Starship for root user"
fi

echo "âœ“ Starship prompt installed and configured"
